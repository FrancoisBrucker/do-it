
<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>MON 2 : Google Apps Script</title>

        <link href="/do-it/assets/node_modules/prismjs/themes/prism-solarizedlight.min.css" rel="stylesheet">
        <link href="/do-it/assets/node_modules/prismjs/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">

        <link href="/do-it/assets/stylesheets/main.css" rel="stylesheet">
    </head>
    <body>
        <script>
        window.MathJax = {
            tex: {
            inlineMath: [
                [
                '$', '$'
                ],
                [
                '\\(', '\\)'
                ]
            ]
            },
            svg: {
            fontCache: 'global'
            }
        };
        </script>
        <script type="text/javascript" id="MathJax-script" src="/do-it/assets/node_modules/mathjax/es5/tex-svg-full.js"></script>

        <header class="border-b-2 border-gray-200 mb-4">
        <div class="max-w-[1000px] mx-auto px-4">
            <div class="min-h-[50px] flex justify-between items-center">
                <a class="mx-2" href="/do-it/">Home</a>
                <div class="flex items-center gap-4 sm:gap-6 ">
                    <a class="" href="/do-it/cs">CS</a>
                    <a class="" href="/do-it/pok">POK</a>
                    <a class="" href="/do-it/mon">MON</a>
                    <a class="" href="/do-it/projets">Projets</a>
                    <a class="hidden sm:block" href="/do-it/promos">Promos</a>
                    <a href="/do-it/search">
                        <svg class="h-5 aspect-square" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"></path>
                        </svg>
                    </a>
                    <a class="hidden sm:block" href="https://github.com/FrancoisBrucker/do-it" target="_blank">
                        <svg class="h-5 aspect-square" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg>
                    </a>
                </div>
            </div>
        </div>
        </header>

        <main class="max-w-[1000px] mx-auto px-4" data-pagefind-body="">
            
<article class="relative">
<h1 class="mb-1">MON 2 : Google Apps Script</h1>
<div class="mb-4">
    
        <div class="px-4 flex flex-wrap items-center">
            
                <div class="font-bold">Tags : </div>
            
            <ul class="flex flex-wrap overflow-auto not-prose list-none my-1 mx-0 px-1 gap-1" data-pagefind-meta="Tags">
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">MON</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">2022-2023</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">temps 1</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">google apps script</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">automatisation</li>
                

            </ul>
            
            
            <div class="hidden" data-pagefind-meta="Type">
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </div>
        </div>
    

    
        <div class="px-4 flex flex-wrap items-center">
            <div class="font-bold">Auteurs : </div>
            <ul class="flex flex-wrap not-prose list-none my-1 mx-0 px-1 gap-1" data-pagefind-meta="Auteurs">
                
                    <li class="bg-blue-200 rounded-full px-2" data-pagefind-filter="Auteurs">Thomas Pont</li>
                
            </ul>
        </div>
    

    
</div>



    
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-purple-500 bg-purple-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
</svg>
<div class="pl-8 mr-8">

<a href="/do-it/promos/">Promotions</a><span class="px-1">/</span><a href="/do-it/promos/2022-2023/">2022-2023</a><span class="px-1">/</span><a href="/do-it/promos/2022-2023/Pont-Thomas/">Thomas Pont</a><span class="px-1">/</span><a href="/do-it/promos/2022-2023/Pont-Thomas/mon/">MON de Thomas</a><span class="px-1">/</span><a href="/do-it/promos/2022-2023/Pont-Thomas/mon/gas/">MON 2 : Google Apps Script</a>

</div></div>




<!-- Début Résumé -->
<p>Google Apps Script</p>
<!-- Début Résumé -->
<h2>Objectif de ce MON</h2>
<p>L'objectif de ce MON est d'automatiser une tâche avec Google App Script.</p>
<p>Ici on cherchera à automatiser l'envoi de mails personnalisés. à des personnes.</p>
<p>Pour cela, on va réaliser un programme qui va automatiser l'envoi de mail lors de l'organisation d'évènements (réunions, cours..). A la fin, il faudrait que l'on ait juste à indiquer dans un Google Sheet, le prénom, le nom, le mail du participant ainsi que la nature, la date et l'heure de l'évènement auquel il est convié et qu'un mail comme celui qui suit s'envoie automatiquement.</p>
<pre class="language-txt"><code class="language-txt">Bonjour Jean Dupont,

Vous êtes conviés à la réunion de fin de projet le 24/10/2022 à 15h.

Cordialement,
Yves Martin</code></pre>
<h2>Réalisation de ce programme</h2>
<p>Dans un premier temps, j'ai relu et étudié les précédents MON fait sur Google App Script pour revoir les principales fonctionnalités déjà utilisé et principalement celle de l'envoi de mail.</p>
<h3>Fichier texte</h3>
<p>Pour commencer on crée un Google Doc avec le texte que l'on souhaite envoyer aux différents destinataires du mail.</p>
<pre class="language-txt"><code class="language-txt"> Bonjour [Prenom] [Nom],

 Vous êtes conviés [Evenement] le [Date] à [Heure].

 Cordialement,
 Yves Martin</code></pre>
<p>Les éléments entre crochets seront ensuite automatiquement remplacé en fonction des informations sur la personne et sur l'évènement.</p>
<p>On doit ensuite convertir ce texte en HTML pour qu'il puisse être bien envoyé. Pour cela, on récupère une fonction publique disponible sur ce <a href="https://github.com/oazabir/GoogleDoc2Html/blob/master/code.js">Github</a>.
On nomme le texte ainsi converti mailBodyHTML</p>
<h3>Google Sheet</h3>
<p>On crée un Google Sheet permettant de réunir les éléments des mails que l'on doit envoyer. On le place dans un onglet intitulé Inscriptions.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Nom</th>
<th style="text-align:left">Prénom</th>
<th style="text-align:left">Mail</th>
<th style="text-align:left">Date</th>
<th style="text-align:left">Heure</th>
<th style="text-align:left">Nom Evènement</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Dupont</td>
<td style="text-align:left">Jean</td>
<td style="text-align:left"><a href="mailto:jean.dupont@gmail.com">jean.dupont@gmail.com</a></td>
<td style="text-align:left">24/10/2022</td>
<td style="text-align:left">15h</td>
<td style="text-align:left">à la réunion de fin de projet</td>
</tr>
<tr>
<td style="text-align:left">Dulieu</td>
<td style="text-align:left">Anna</td>
<td style="text-align:left"><a href="mailto:anna.dulieu@gmail.com">anna.dulieu@gmail.com</a></td>
<td style="text-align:left">24/10/2022</td>
<td style="text-align:left">15h</td>
<td style="text-align:left">à la réunion de fin de projet</td>
</tr>
</tbody>
</table>
<h3>Personnalisation du mail</h3>
<p>Il faut ensuite qu'on écrive un script qui prend les informations du tableau et qui complète automatiquement le texte du mail.</p>
<p>Dans une fonction, on extrait les données du tableau de cette manière :</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">const</span> nom <span class="token operator">=</span> inscriptions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> prenom <span class="token operator">=</span> inscriptions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> email <span class="token operator">=</span> inscriptions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>inscriptions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dateFormatee <span class="token operator">=</span> <span class="token class-name">Utilities</span><span class="token punctuation">.</span><span class="token function">formatDate</span><span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token string">"GMT+1"</span><span class="token punctuation">,</span> <span class="token string">"dd/MM/YYYY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> heure <span class="token operator">=</span> inscriptions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sujet <span class="token operator">=</span> inscriptions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-red-500 bg-red-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
<div class="pl-8 mb-2 mr-8">
<p><strong>Attention</strong> aux dates</p>
</div><div class="pl-8 mr-8">
<p>Il faut faire attention à la gestion des dates dans le tableau. Si on fait seulement</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">const</span> date <span class="token operator">=</span> inscriptions <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<p>rien ne sera extrait du tableau
De même si on formate pas la date on récupère également l'heure de minuit ainsi que le fuseau horaire de là où on se situe.
Il est donc important de bien l'extraire et de bien la formater.</p>
</div></div>
<p>On place toutes ses données ainsi récupérées dans un tableau <em>variables</em>.
Pour compléter le texte on utilise la fonction suivante :</p>
<pre class="language-java"><code class="language-java">  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> id in variables<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>variables<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mailBodyHTML <span class="token operator">=</span> mailBodyHTML<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"["</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">"]"</span><span class="token punctuation">,</span>variables<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<p>Ceci permet de lire le texte du mail et de remplacer les [] par l'information correspondante.</p>
<h3>Envoi du mail</h3>
<p>Il faut maintenant lier les scripts pour le texte ainsi former puisse être envoyé et qu'il le soit à la bonne personne.</p>
<p>Pour cela, on peut utiliser la commande ci-dessous :</p>
<pre class="language-java"><code class="language-java"><span class="token class-name">MailApp</span><span class="token punctuation">.</span><span class="token function">sendEmail</span><span class="token punctuation">(</span>mailTo<span class="token punctuation">,</span> mailSubject<span class="token punctuation">,</span> mailBodyHTML<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token operator">^</span><span class="token operator">></span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">></span><span class="token operator">/</span>g<span class="token punctuation">,</span> ''<span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>On peut choisir l'intitulé tel que Convocation qu'on peut stocker dans une constante.</p>
<p>On peut retrouver ici le tableau avec le Google App Script final. L'envoi du mail se fait lorsqu'on l'on lance la fonction gestionConvocations.</p>
<p>Ainsi on peut lancer manuellement cette fonction et le bon mail s'enverra à Jean et Anna. Il reste cependant un problème. Si on décide d'envoyer ce mail à quelqu'un d'autre, qu'on rajoute cette personne dans le tableau, le mail se renverra également à Jean et Anna.
Pour pallier à ce problème on peut ajouter une colonne intitulée <em>Mail envoyé</em>. On place des cases non cochées dans ce tableau. Lorsque le mail est bien envoyé un ajoute une ligne dans le code pour que la case soit cochée.</p>
<pre class="language-java"><code class="language-java">inscriptionsSheet<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"TRUE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Si on relance le script, en vérifiant si la case est bien décochée, seules les lignes non cochées vont recevoir le mail.</p>
<h2>Lien vers le code</h2>
<p><a href="../code/code_gas">Mon code</a></p>


</article>

        </main>


        <footer class="min-h-[50px] border-t-2 border-gray-200 mt-4">
            <div class="max-w-[1000px] mx-auto px-4">
                <div class="min-h-[50px] flex justify-center items-center">
                    <p class="text-center">
                        <span style="font-family: Consolas, sans-serif;">Do_<span style="color: #4a86e8">It</span></span> : Développement et Organisation en IT
                    </p>
                </div>
            </div>
        </footer>

        <script>
        MathJax
            .startup
            .document
            .getMathItemsWithin(document.body);
        </script>
        <script src="/do-it/assets/node_modules/prismjs/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
    </body>
</html>
