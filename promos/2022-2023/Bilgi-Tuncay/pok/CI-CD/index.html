
<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>CI/CD : Déploiement et Integration continues</title>

        <link href="/do-it/assets/node_modules/prismjs/themes/prism-solarizedlight.min.css" rel="stylesheet">
        <link href="/do-it/assets/node_modules/prismjs/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">

        <link href="/do-it/assets/stylesheets/main.css" rel="stylesheet">
    </head>
    <body>
        <script>
        window.MathJax = {
            tex: {
            inlineMath: [
                [
                '$', '$'
                ],
                [
                '\\(', '\\)'
                ]
            ]
            },
            svg: {
            fontCache: 'global'
            }
        };
        </script>
        <script type="text/javascript" id="MathJax-script" src="/do-it/assets/node_modules/mathjax/es5/tex-svg-full.js"></script>

        <header class="border-b-2 border-gray-200 mb-4">
        <div class="max-w-[1000px] mx-auto px-4">
            <div class="min-h-[50px] flex justify-between items-center">
                <a class="mx-2" href="/do-it/">Home</a>
                <div class="flex items-center gap-4 sm:gap-6 ">
                    <a class="" href="/do-it/cs">CS</a>
                    <a class="" href="/do-it/pok">POK</a>
                    <a class="" href="/do-it/mon">MON</a>
                    <a class="" href="/do-it/projets">Projets</a>
                    <a class="hidden sm:block" href="/do-it/promos">Promos</a>
                    <a href="/do-it/search">
                        <svg class="h-5 aspect-square" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"></path>
                        </svg>
                    </a>
                    <a class="hidden sm:block" href="https://github.com/FrancoisBrucker/do-it" target="_blank">
                        <svg class="h-5 aspect-square" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg>
                    </a>
                </div>
            </div>
        </div>
        </header>

        <main class="max-w-[1000px] mx-auto px-4" data-pagefind-body="">
            
<article class="relative">
<h1 class="mb-1">CI/CD : Déploiement et Integration continues</h1>
<div class="mb-4">
    
        <div class="px-4 flex flex-wrap items-center">
            
                <div class="font-bold">Tags : </div>
            
            <ul class="flex flex-wrap overflow-auto not-prose list-none my-1 mx-0 px-1 gap-1" data-pagefind-meta="Tags">
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">POK</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">2022-2023</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">temps 3</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">CI/CD</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">jenkins</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">docker</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">TDD</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">nextjs</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">react</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">CMS</li>
                

            </ul>
            
            
            <div class="hidden" data-pagefind-meta="Type">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </div>
        </div>
    

    
        <div class="px-4 flex flex-wrap items-center">
            <div class="font-bold">Auteurs : </div>
            <ul class="flex flex-wrap not-prose list-none my-1 mx-0 px-1 gap-1" data-pagefind-meta="Auteurs">
                
                    <li class="bg-blue-200 rounded-full px-2" data-pagefind-filter="Auteurs">Tuncay Bilgi</li>
                
            </ul>
        </div>
    

    
</div>



    
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-purple-500 bg-purple-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
</svg>
<div class="pl-8 mr-8">

<a href="/do-it/promos/">Promotions</a><span class="px-1">/</span><a href="/do-it/promos/2022-2023/">2022-2023</a><span class="px-1">/</span><a href="/do-it/promos/2022-2023/Bilgi-Tuncay/">Tuncay Bilgi</a><span class="px-1">/</span><a href="/do-it/promos/2022-2023/Bilgi-Tuncay/pok/">POK de Tuncay</a><span class="px-1">/</span><a href="/do-it/promos/2022-2023/Bilgi-Tuncay/pok/CI-CD/">CI/CD : Déploiement et Integration continues</a>

</div></div>




<p>Dans ce POK, nous allons améliorer mon projet précédent : l'Artblog, en lui ajoutant de nouvelles pages et en créant un environnement d'intégration et de déploiement continue.</p>
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-pink-500 bg-pink-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-pink-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
</svg>
<div class="pl-8 mb-2 mr-8">
<p>Niveau avancé</p>
</div><div class="pl-8 mr-8">
<p>C'est un POK avancé car il met en relation plusieurs technologies différentes qu'il faut donc connaître, il demande de solides bases en :</p>
<ul>
<li>Linux et shell</li>
<li>Développement web fullstack</li>
<li>Docker</li>
<li>Jenkins</li>
<li>Programmation par les tests</li>
</ul>
</div></div>
<div class="relative drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-indigo-500 bg-indigo-100">
<details class="group">
<summary class="list-none py-0.5">
<svg class="group-open:hidden absolute w-7 h-7 pl-1 pt-0.5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path>
</svg>
<svg class="group-open:block hidden absolute w-7 h-7 pl-1 pt-0.5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
</svg>
<div class="pl-8 font-bold inline-block">
<p>Ce POK ce base sur plusieurs MON et POK qui ont précédés, voici la liste des projets dont j'ai eu besoin.</p>
</div>
<svg class="group-open:hidden inline-block pl-3 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
</svg>
</summary>
<div class="mx-8 pb-2">
<ul>
<li>Le projet sur lequel ce POK se base : Artblog - <a href="https://francoisbrucker.github.io/do-it/pok/un-site-chez-moi/TBi/Artblog/">Dev du Blog</a> | <a href="https://francoisbrucker.github.io/do-it/pok/un-site-chez-moi/TBi/ServeurDistant/">Mise sur Site distant</a></li>
<li>Le MON introduisant <a href="https://francoisbrucker.github.io/do-it/mon/TBi/MON/Docker/">Docker</a></li>
<li>Le Mon introduisant <a href="https://francoisbrucker.github.io/do-it/mon/TBi/MON/Jenkins/">Jenkins</a></li>
</ul>
</div>
</details>     
</div>
<p>Enfin, voici le lien du <a href="https://github.com/TuncayBilgi/artblog">repository GitHub</a> où vous pourrez trouver tous le code.</p>
<h2>Introduction :</h2>
<h3>Point de départ :</h3>
<p>Le Artblog est un projet de blog que j'ai mené toute l'année scolaire. Voici un résumé de ce qui à été fait jusqu'ici :</p>
<ul>
<li>Développement du site en suivant un tuto YouTube.</li>
<li>Déploiement du site sur le serveur ovh1 de Do-It.</li>
<li>Conteneurisation du projet.</li>
<li>Ajout d'un script de déploiement qui permet de mettre le site à jour en ligne automatiquement.</li>
<li>Ajout d'une instance Jenkins pour, plus tard, automatiser la production.</li>
</ul>
<h3>Ce qu'il reste à faire :</h3>
<p>Nous allons finir de mettre en place l'automatisation autour du projet.
Le but final est d'avoir un site disponible sur internet. Quand un développeur ajoute une fonctionnalité ou corrige un bug, un serveur détecte automatiquement qu'il y des changements qui ne sont pas sur internet. A ce moment, il effectue une batterie de tests sur le code source, si les tests passent, le serveur déploie automatiquement la nouvelle version sur le net.</p>
<p>Techniquement cela veut dire qu'au premier sprint nous allons :</p>
<ul>
<li>Mettre en place Jest pour incorporer des tests dans l'application.</li>
<li>Coder une nouvelle fonctionnalité en TDD.</li>
</ul>
<p>Au second sprint :</p>
<ul>
<li>Mettre en place le script Jenkins.</li>
<li>Tester l'intégration de bout en bout.</li>
</ul>
<h3>Réalisation des sprints :</h3>
<p>La Todo des sprints était volontairement vague car le temps manque trop en fin d'année et il est bon de se concentrer sur l'essentiel des tâches et ajouter des détails si on a du temps en trop, ce qui n'a pas été mon cas. J'ai néanmoins pus atteindre mes objectifs fixés.</p>
<p>Le résultat est un blog qui fonctionne bien, quoiqu'avec parfois trop de latence. C'est surtout un site que l'on peut maintenir correctement et en équipe.</p>
<h2>Premier Sprint :</h2>
<h3>Ajout de Jest :</h3>
<p>On installe Jest pour pouvoir créer des tests unitaires :</p>
<p><code>npm install --save-dev jest</code></p>
<p>Jest est très pratique, il permet de lancer tous les tests contenues dans les fichiers présents dans le répertoire &quot;<strong>tests</strong>&quot;</p>
<p>La batterie de tests se lance avec <code>npx jest</code>, que l'on eut ajouter dans le config.json pour utiliser <code>npm run test</code>.
le fichier config.json ressemble alors à cela :</p>
<pre class="language-json " style="counter-reset: linenumber 0"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"test"</span> <span class="token operator">:</span> <span class="token string">"npx jest"</span><span class="token punctuation">,</span>
    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"next dev"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"next build"</span><span class="token punctuation">,</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"next start -p 10438"</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre>
<p>Ensuite on créer un dossier <strong>tests</strong> à la racine et on y créer le fichier &quot;categoriepage.js&quot; qui contiendra tous les tests liés à la fonctionnalité du site que l'on va ajouter.</p>
<p>Jest utilise des méthodes built-in pour tester pleins de choses différentes, allez voir la documentation sur internet pour savoir lesquelles utiliser.</p>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-red-500 bg-red-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
<div class="pl-8 mr-8">
<p>Par défaut Jest utilise la syntaxe <code>const a = require('./module')</code> qui n'est pas compatible avec le reste du projet qui lui est en ES6 et donc utilise la syntaxe suivante <code>import {a} from module</code></p>
</div></div>
<p>Pour pallier ce problème, on créer un fichier de configuration jest qui vient supplanté la configuration par défaut et qui demande à jest d'utiliser ES6 : config.jest</p>
<pre class="language-js " style="counter-reset: linenumber 0"><code class="language-js"><span class="token keyword">const</span> nextJest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"next/jest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> createJestConfig <span class="token operator">=</span> <span class="token function">nextJest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">dir</span><span class="token operator">:</span> <span class="token string">"./"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> customJestConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">moduleDirectories</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node_modules"</span><span class="token punctuation">,</span> <span class="token string">"&lt;rootDir>/"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">createJestConfig</span><span class="token punctuation">(</span>customJestConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Nous voilà prêt pour la TDD!</p>
<h3>TDD: Ajout d'une page dans mon site.</h3>
<p>Je veux ajouter une série de pages dynamiques. On clique sur une catégorie de publication, cela nous redirige vers une page qui liste tous les posts possédant cette catégorie.</p>
<p>Pour ce faire, on commence par écrire les tests qui devront être validés par le code de la nouvelle fonctionnalité :</p>
<pre class="language-js " style="counter-reset: linenumber 0"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> getCategories<span class="token punctuation">,</span>getPostsByCat <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../services"</span>

<span class="token function">test</span><span class="token punctuation">(</span>
    <span class="token string">'CategoriesProps are fetched'</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> categories <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getCategories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>categories<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContainEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span> <span class="token operator">:</span><span class="token string">'Sculpture'</span><span class="token punctuation">,</span><span class="token literal-property property">slug</span><span class="token operator">:</span><span class="token string">'sculpture'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre>
<p>Ce test s'assure que les informations fetcher sont sous le bon format et qu'elle sont bien cohérentes.</p>
<p>Maintenant, il faut implémenter le code qui valide le test, ici il nous faut une fonction qui renvoie les données demander, c'est un fetch.:</p>
<ul>
<li>Implémentation minimale :</li>
</ul>
<pre class="language-js " style="counter-reset: linenumber 0"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getCategories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span> <span class="token operator">:</span><span class="token string">'Sculpture'</span><span class="token punctuation">,</span><span class="token literal-property property">slug</span><span class="token operator">:</span><span class="token string">'sculpture'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Cette implémentation paraît débile, mais si vous coder en équipe, elle permet de valider le test ET de laisser à vous collègue la possibilité de coder le front en ayant une idée de la structure de données à laquelle le code doit s'attendre.</p>
<ul>
<li>Implémentation finale :
C'est une requête graphQL il n'y à pas d’intérêt à la coller ici.</li>
</ul>
<p>Après ça, on code le front, allez voir le premier POK ou des MON Reacts pour des tutos détaillés sur comment faire. Voici les résultats :</p>
<img src="../images/artblog-cat1.png" alt="page de sculpture" style="height: 250px;width:600px; margin: 0 auto;">
<img src="../images/artblog-cat2.png" alt="page de sculpture" style="height: 250px;width:500px; margin: 0 auto;">
<h3>Conclusion Premier sprint :</h3>
<p>La partie facile de ce POK est terminée.
Tout c'est bien passé, on pourrait continuer en :</p>
<ul>
<li>Implémentant des tests unitaires pour toutes les fonctionnalités du projet.</li>
<li>Implémentant des tests de bout en bout.</li>
<li>Implémentant des snapshots qui permettent de tester le front.</li>
</ul>
<p>Mais je n'ai pas le temps pour ces options, on passe à la suite.</p>
<h2>Second sprint :</h2>
<h3>Jenkins :</h3>
<p>La mise en place de Jenkins dans un container peut être vu dans le MON sur Jenkins.
Néanmoins, cette mise en place possède plusieurs problème :</p>
<ul>
<li>Jenkins ne possède même pas les librairies nécessaires pour faire tourner le projet.</li>
<li>Jenkins ne possède pas les droits et les clés nécessaires pour faire quoi que ce soit.</li>
<li>Il faut créer le script d'automatisation.</li>
</ul>
<p>On y va dans l'ordre.</p>
<h4>L'installation propre :</h4>
<p>Jenkins à besoin de node, de git,de ssh etc... pour faire tourner le projet.
Dans le MON Jenkins on avait créer un conteneur Jenkins en prenant simplement l'image officielle.
Ici, nous allons utiliser l'image officielle alpine (basée sur Linux alpine) a laquelle j'ajoute node et tmux (je n'ai pas eu besoin de tmux).</p>
<p>Voici le dockerfile :</p>
<pre class="language-dockerfile " style="counter-reset: linenumber 0"><code class="language-dockerfile"><span class="token instruction"><span class="token keyword">FROM</span> jenkins/jenkins:lts-alpine-jdk11</span>

<span class="token instruction"><span class="token keyword">USER</span> root</span>

<span class="token instruction"><span class="token keyword">RUN</span> apk update &amp;&amp; apk add nodejs npm</span>
<span class="token instruction"><span class="token keyword">RUN</span> apk add tmux</span>

<span class="token instruction"><span class="token keyword">USER</span> jenkins</span>

</code></pre>
<p>et le docker-compose qui s'occupe des connexions :</p>
<pre class="language-yml " style="counter-reset: linenumber 0"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">jenkins</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> .
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"8080:8080"</span>
      <span class="token punctuation">-</span> <span class="token string">"50000:50000"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> jenkins_home<span class="token punctuation">:</span>/var/jenkins_home
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">JAVA_OPTS</span><span class="token punctuation">:</span> <span class="token string">"-Djenkins.install.runSetupWizard=false"</span>

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">jenkins_home</span><span class="token punctuation">:</span>
</code></pre>
<p>Grâce à cela on à un conteneur qui contient Jenkins et qui enregistre ces données entre deux lancements.</p>
<h4>Les secrets :</h4>
<p>Tous d'abord on donne à Jenkins, dans la partie <strong>manage credentials</strong> les clés nécessaires à faire fonctionner et à déployer le projet.</p>
<p>Je lui donne alors ma clé d'API et une clé ssh qui possède les accès au serveur ovh1, où je déploie le site (la mise en place de ce déploiement ce fait dans mon deuxième POK).</p>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-red-500 bg-red-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
<div class="pl-8 mr-8">
<p>Ces informations, qu'on appelle à juste titre des <strong>secrets</strong>, sont hautement confidentielles. Il ne faut surtout pas les mettre sur serveur qui peuvent être compromis, c'est à dire tous les serveurs qui ne vous appartiennent pas et qui ont accès à internet.
Ainsi il ne faut pas stocker vos clés ssh sur ovh1, ni sur github, au risque de vous la voir voler, et que quelqu'un achète des armes avec votre carte bleu au marché noir.</p>
</div></div>
<p>Jenkins est en local, si il est accédé par l'extérieur c'est que quelqu'un à déjà le contrôle sur votre pc. Aussi, les secrets qui y sont stockés sont cryptés, on peut donc y mettre de façon sûre la clé ssh privée qui va déployé sur ovh1, ainsi que les variables d'environnement de votre application.
Je recommande cependant de créer une clé ssh uniquement pour Jenkins et de ne pas mettre la votre, si elle est compromise il suffira de bloquer les accès à cette unique clé.</p>
<p>Ne donnez pas non plus accès à ovh1 à votre repository github!</p>
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-cyan-500 bg-cyan-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-cyan-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
</svg>
<div class="pl-8 mr-8">
<p>Ces secrets sont accessible depuis le Jenkinsfile grâce aux méthodes withcredentials() et on peut communiquer en ssh avec le ssh-agent, je vous invite à lire la doc Jenkins, même si elle est parfois lunaire.</p>
</div></div>
<ul>
<li>Résultats :
<img src="../images/jenkins-cred.png" alt="credentials"></li>
</ul>
<h4>Le jenkinsfile :</h4>
<p>Le <a href="https://github.com/TuncayBilgi/artblog/blob/main/Jenkinsfile">jenkinsfile</a> est le fichier dont va se servir Jenkins pour executer votre Pipeline, voir le MON Jenkins si jamais vous ne l'avez pas encore fait.
Je ne détaille pas le code, il est disponible sur le repository de mon projet sur Github.</p>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-red-500 bg-red-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
<div class="pl-8 mr-8">
<p>Jenkins est une machine à gaz très capricieuse. Avec des milliers de plugins, et plus d'une dizaine année d’existence, il existe des millions de manières différentes de faire la même chose, et quand vous en choisissez une, ça ne marche pas.
Évitez les interactions complexes entre Jenkins et d'autres site. Si vous voulez faire quelque chose qui existe utilisez ce qui existe déjà, et sinon bon courage.</p>
</div></div>
<p>Ici, on choisit la méthode suivante :</p>
<ul>
<li>Toutes les heures le job de Jenkins démarre.</li>
<li>Jenkins possède une liste qui contient les hash des commits de mon projet.</li>
<li>Il pull la dernière version du main du Github mon Projet.</li>
<li>Il regarde le hash du dernier commit sur main.</li>
<li>Si ce hash n'est pas dans la liste, cela veut dire que le projet n'est pas déployé, il réalises doc plusieurs tâches :
<ul>
<li>Il lance 'npx jest' pour tester la dernière version du projet.</li>
<li>Si les tests passent, il déploie le projet grâce à mon script qui date du POK d'avant sur ovh1 en se connectant par ssh.</li>
<li>si le déploiement c'est déroulé sans encombre, il ajoute le hash du dernier commit dans sa liste.</li>
</ul>
</li>
<li>Si ce hash est déjà dans la liste, Jenkins ne fait rien, il n'y a rien besoin de faire.</li>
</ul>
<p>On met en place tout ça et voici les résultat :</p>
<div style=" display: grid;grid-template-columns: repeat(3, minmax(0, 1fr))">
<img src="../images/jenkins-hour1.png" alt="page d'index" style="grid-column : 1 ;grid-row : 1">
<img src="../images/jenkins-hour2.png" alt="pipeline log" style="grid-column : 2 ;grid-row : 1">
<img src="../images/jenkins-hour3.png" alt="deploy list" style="grid-column : 3 ;grid-row : 1 ">
</div>
<p>On peut voir, de gauche à droite, que Jenkins repère les différents commits, ensuite il execute la pipeline où il lance des tests et où il build et enfin, la pipeline est exécutée périodiquement.</p>
<h3>Conclusions sprint 2 :</h3>
<p>l’utilisation de jenkins n'est pas une chose aisée, et je vous épargne toutes les autres solutions que j'ai testé avant d'arriver à celle-ci qui est juste convenable. Cependant, une bonne partie de ceci serait plus simple si jenkins était un serveur ayant accès à un réseau, comme ça devrait être le cas normalement.
J'ai pris le temps de réaliser l'essentiel de ce que je voulais, on pourrai aller plus loin en :</p>
<ul>
<li>Mettant en place une messagerie qui envoie un mail si la pipeline est cassée.</li>
<li>Mettant en place une seconde pipeline qui s'occupe seulement de verifier que le site est disponible sur internet et qui le redéploie sinon, sans build (c'est possible facilement grâce à l'implémentation de mon script).</li>
</ul>
<h2>Conclusion POK 1,2 et 3 :</h2>
<p>Ces trois POK m'ont permis de m'initier au développement web.
J'ai commencé l'année en tant que débutant ne connaissant que html,css et bootstrap. Aujourd'hui, je suis capable de coder un site (simple) de bout en bout, j'ai des notions d'architecture système, j'ai connaissances de certaines best practices et surtout j'ai découvert le pan Dev-ops du développement web.</p>
<p>Finalement, j'ai une site fonctionnel qui m'a permis de beaucoup apprendre, les efforts en valaient la peine et je suis satisfait du résultat.</p>


</article>

        </main>


        <footer class="min-h-[50px] border-t-2 border-gray-200 mt-4">
            <div class="max-w-[1000px] mx-auto px-4">
                <div class="min-h-[50px] flex justify-center items-center">
                    <p class="text-center">
                        <span style="font-family: Consolas, sans-serif;">Do_<span style="color: #4a86e8">It</span></span> : Développent et Organisation en IT
                    </p>
                </div>
            </div>
        </footer>

        <script>
        MathJax
            .startup
            .document
            .getMathItemsWithin(document.body);
        </script>

    </body>
</html>
