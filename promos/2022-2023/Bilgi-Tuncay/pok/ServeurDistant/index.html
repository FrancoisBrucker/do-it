
<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Artblog Déploiement</title>

        <link href="/do-it/assets/node_modules/prismjs/themes/prism-solarizedlight.min.css" rel="stylesheet">
        <link href="/do-it/assets/node_modules/prismjs/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">

        <link href="/do-it/assets/stylesheets/main.css" rel="stylesheet">
    </head>
    <body>
        <script>
        window.MathJax = {
            tex: {
            inlineMath: [
                [
                '$', '$'
                ],
                [
                '\\(', '\\)'
                ]
            ]
            },
            svg: {
            fontCache: 'global'
            }
        };
        </script>
        <script type="text/javascript" id="MathJax-script" src="/do-it/assets/node_modules/mathjax/es5/tex-svg-full.js"></script>

        <header class="border-b-2 border-gray-200 mb-4">
        <div class="max-w-[1000px] mx-auto px-4">
            <div class="min-h-[50px] flex justify-between items-center">
                <a class="mx-2" href="/do-it/">Home</a>
                <div class="flex items-center gap-4 sm:gap-6 ">
                    <a class="" href="/do-it/cs">CS</a>
                    <a class="" href="/do-it/pok">POK</a>
                    <a class="" href="/do-it/mon">MON</a>
                    <a class="" href="/do-it/projets">Projets</a>
                    <a class="hidden sm:block" href="/do-it/promos">Promos</a>
                    <a href="/do-it/search">
                        <svg class="h-5 aspect-square" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"></path>
                        </svg>
                    </a>
                    <a class="hidden sm:block" href="https://github.com/FrancoisBrucker/do-it" target="_blank">
                        <svg class="h-5 aspect-square" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg>
                    </a>
                </div>
            </div>
        </div>
        </header>

        <main class="max-w-[1000px] mx-auto px-4" data-pagefind-body="">
            
<article class="relative">
<h1 class="mb-1">Artblog Déploiement</h1>
<div class="mb-4">
    
        <div class="px-4 flex flex-wrap items-center">
            
                <div class="font-bold">Tags : </div>
            
            <ul class="flex flex-wrap overflow-auto not-prose list-none my-1 mx-0 px-1 gap-1" data-pagefind-meta="Tags">
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">POK</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">2022-2023</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">temps 2</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">Linux</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">ssh</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">deploy</li>
                
                    <li class="bg-yellow-200 rounded-full px-2" data-pagefind-filter="Tags">bash</li>
                

            </ul>
            
            
            <div class="hidden" data-pagefind-meta="Type">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </div>
        </div>
    

    
        <div class="px-4 flex flex-wrap items-center">
            <div class="font-bold">Auteurs : </div>
            <ul class="flex flex-wrap not-prose list-none my-1 mx-0 px-1 gap-1" data-pagefind-meta="Auteurs">
                
                    <li class="bg-blue-200 rounded-full px-2" data-pagefind-filter="Auteurs">Tuncay Bilgi</li>
                
            </ul>
        </div>
    

    
</div>



    
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-purple-500 bg-purple-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
</svg>
<div class="pl-8 mr-8">

<a href="/do-it/promos/">Promotions</a><span class="px-1">/</span><a href="/do-it/promos/2022-2023/">2022-2023</a><span class="px-1">/</span><a href="/do-it/promos/2022-2023/Bilgi-Tuncay/">Tuncay Bilgi</a><span class="px-1">/</span><a href="/do-it/promos/2022-2023/Bilgi-Tuncay/pok/">POK de Tuncay</a><span class="px-1">/</span><a href="/do-it/promos/2022-2023/Bilgi-Tuncay/pok/ServeurDistant/">Artblog Déploiement</a>

</div></div>




<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-pink-500 bg-pink-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-pink-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
</svg>
<div class="pl-8 mr-8">
<ul>
<li>Connaissance de commandes UNIX : ssh,scp,ls,cat,touch etc...</li>
<li>Accès ssh au serveur ovh1</li>
<li>Avoir un projet à déployer</li>
</ul>
<p>Dans le second sprint, on utilise des scripts bash qui nécessite une compréhension du shell assez complète.</p>
</div></div>
<h1>Déploiement sur un site distant.</h1>
<p>Le but du POK est d'appréhender le déploiement de projets sur un serveur.
Ici, je vais spécifiquement déployer le site développé pendant le POK1 : Artblog, qui est un blog en Javascript, plus précisément, il utilise Next.js et la base de données est hébergée par un service cloud.</p>
<h3>Remarque :</h3>
<p>Mon back étant hébergé sur un HeadlessCMS il n'y a pas besoin de déployer la BDD, je vais donc potentiellement créer un mini projet qui contient une BDD classique juste pour me frotter au déploiement complet d'une application.</p>
<h2>Objectifs finaux :</h2>
<ul>
<li>Pouvoir acceder à mon site sur ovh1.</li>
<li>Faire en sorte que le contenu se mette à jour sans nécessiter de redéploiement.</li>
</ul>
<h1>Gestion de Projet :</h1>
<p>Organisation en deux sprints séparés par le point POK.</p>
<h2>Taches Premier sprint :</h2>
<ul>
<li>Explorer le serveur ovh1 pour voir comment marche le déploiement</li>
<li>Corriger les bugs majeurs du Artblog</li>
<li>Build une version du Artblog</li>
<li>Deployer Artblog sur ovh1</li>
</ul>
<h2>Backlog :</h2>
<ul>
<li>Mettre en place une fenêtre permanente.</li>
<li>Bonus : Mettre en place une base de données</li>
<li>Bonus : mettre en place une automatisation avec Jenkins.</li>
</ul>
<h1>Premier sprint:</h1>
<h2>Premiers pas</h2>
<p>Le serveur est organisée de la même manière pour chaque compte. Mon compte est curcuma donc je prend cela pour exemple et je me concentre sur la partie node puisque le projet que je veut mettre en place est basé sur node.js :</p>
<p>_ Home
|_Curcuma
|_Django
|_Flask
|_java
|_node
|<em>example.js
|</em> readme.txt</p>
<p>Le <strong>readme</strong> contient les addresses à questionner selon le port que l'on veut atteindre.
Dans notre cas, on vois dans le fichier <code>example.js</code> que l'on utilise le port 10438 et que pour communiquer à travers ce port, on doit envoyer nos requêtes à <code>node.curcuma.ovh1.ec-m.fr</code>.</p>
<p>Avec la commande <code>node example.js</code> on lance le programme et on met donc en place notre serveur. Sur un navigateur, <a href="http://node.curcuma.ovh1.ec-m.fr">node.curcuma.ovh1.ec-m.fr</a> nous renvoie <code>Hello World</code>.</p>
<h2>Mise en production du Artblog :</h2>
<h3>Mise en place du projet sur ovh1 :</h3>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-red-500 bg-red-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
<div class="pl-8 mr-8">
<p>Ce n'est pas une manière propre de faire sur un serveur de production car on copie tous le repo dans le serveur alors qu'il n'a besoin que de la branche main. Dans un chapitre suivant on recommence plus proprement.</p>
</div></div>
<p>Grâce à github, on va cloner le projet dans le dossier node.</p>
<p>Sur ovh1,on vérifie qu'il y a git :</p>
<p>git --version</p>
<p>On clone ensuite notre projet dans le dossier node. Puisque le projet est publique, il n'y a rien de spéciale à faire, sous les conseils de Joe, on utilise directement le lien https. Puisque l'on à jamais utilisé git avec des commande et que nous somme par conséquent un peu nul, on lis la documentation avec <code>git --help</code> et on trouve ce qui nous intéresse <code>git clone</code> et <code>git help clone</code> pour toujours plus de documentation.</p>
<p>On clone :</p>
<p>git clone <a href="https://github.com/TuncayBilgi/artblog.git">https://github.com/TuncayBilgi/artblog.git</a></p>
<p>Cela créer un dossier Artblog avec tous les fichiers nécessaires dedans, sauf certains que je n'ai pas mis dans le git comme mes fichiers d'environnement qui possèdent les clés d'API.</p>
<p>Ensuite, on exécute les commandes nécessaires à installer le reste des fichiers :</p>
<p>npm install</p>
<p>Je copie-colle mon fichier d'environment :</p>
<p>scp ./.env <a href="mailto:curcuma@ovh1.ec-m.fr">curcuma@ovh1.ec-m.fr</a>/node</p>
<h3>Test de la mise en production sur mon ordinateur :</h3>
<p>Avec Next.js, certaines commandes servent à la mise en production :</p>
<p>npm run dev // Lance le projet en mode développement en local
npm run build // build le projet
npm run start -p PORT //lance le serveur de production sur le port indiqué</p>
<p>On lance le build, après un certain temps il semble que tout marche, on peut alors essayer de lancer l'application sur un port différent que le port par défaut (3000) car on aura besoin de le faire sur ovh1.</p>
<h3>Changement de port :</h3>
<p>Le serveur ovh1 nous octroie un port bien précis pour y mettre notre application. On ne peut donc pas lancer le programme sur n'importe quel port et sûrement pas le port par défaut. Pour le changer, cela dépend de la technologie utilisée. Avec un serveur node tout simple, il suffit de modifier le port dans le fichier js qui lance le processus. Pour nous, d'après la documentation, nous devon modifier la commande <code>npm run start</code>. Cela ce fait dans le fichier package.json où l'on rentre :</p>
<p>&quot;start&quot;: &quot;next start -p 8080&quot;</p>
<p>Ce qui devrait lancer l'application sur le port 8080.</p>
<p>Pour lancer sur un autre port, on va d'abord vérifier qu'il est libre. Par exemple, on active le port 3000 avec <code>npm run start</code> et en lançant cette commande dans le Powershell : <code>Get-NetTCPConnection | where Localport -eq 3000 | select Localport,OwningProcess</code>, on voit qu'un processus écoute le port 3000. Si le port n'est pas écouté, rien ne s'affiche.</p>
<p>On vérifie que le port 8080 est libre puis on lance l'application sur ce port.</p>
<p>npm run start
Get-NetTCPConnection | where Localport -eq 8080 | select Localport,OwningProcess</p>
<p>La dernière commande renvoie :</p>
<p>Localport OwningProcess</p>
<hr>
<p>8080         17516</p>
<p>C'est prometteur. On passe sur le port 10438 qui sera utilisé sur ovh1.</p>
<h3>Faire du git proprement:</h3>
<p>Comme précisé précédemment, on a copié l’entièreté du repo dans le serveur de production. On oublie et on refait.
On commence par supprimer l'ancien dossier. Je ne sais pas si il y a une bonne manière de le faire et je n'ai pas regardé. Ici, je supprime le dossier et tout ce qu'il y avait dedans, ce qui peut être dangereux.</p>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-red-500 bg-red-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
<div class="pl-8 mr-8">
<p>Si vous aviez des fichiers importants, tout va sauter, vérifiez 2 fois avant de lancer des commandes qui commencent par rm -r</p>
</div></div>
<p>// Dans ovh1 [...]/node
rm -r artblog/</p>
<p>Ensuite, on pull proprement le projet :</p>
<p>git init
git remote add origin <a href="https://github.com/TuncayBilgi/artblog.git">https://github.com/TuncayBilgi/artblog.git</a>
git pull origin main</p>
<p>Ici, seul la branche main est clonée sur le serveur. Il suffit de replacer le fichier .env et on peut potentiellement tester le site.
Pou mettre le repo à jour sur le serveur il suffit de :</p>
<p>git fetch origin main
git reset --hard origin/main
git clean -fdx // attention cela surprime tous les fichiers non présent dans la branche, notamment le fichier .env si il existe, cette        commande est optionnelle</p>
<p>Ou plus simplement :</p>
<p>git pull origin master</p>
<h3>Letsgo on test enfin :</h3>
<p>Tous les préparatifs sont faits, il ne reste qu'à build l'application sur le serveur, puis la lancer :</p>
<p>npm run build
npm run start</p>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-red-500 bg-red-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
<div class="pl-8 mr-8">
<p>Ne lancez pas d'applications en mode dev sur le serveur de production, et de manière générale, faites attention aux ports que vous allez utiliser.</p>
</div></div>
<p>L'application est disponible sur internet à l'adresse <code>node.curcuma.ovh1.ec-m.fr</code> et tout marche correctement.</p>
<p>Problème, quand on ferme le terminale, l'application s'arrête.</p>
<h3>Lancer l'application de façon permanente :</h3>
<p>En effet, exit le terminal tue tous les processus sur ovh1 qui ont été lancés depuis notre propre terminale. Ce n'est pas ce qu'on veut car ça signifie qu'on ne peut pas éteindre notre ordinateur sans que ça coupe l'application.</p>
<p>Il faut donc créer un terminale sur le serveur ovh1 qui ne s'éteigne pas quand on éteint celui de notre ordinateur. Sous les conseils de M.Brucker, on utilise simplement la commande screen qui permet de lancer des terminaux et des processus en tâche de fond.</p>
<p>screen -S artblog // Nous emmène dans un nouveau terminale.
npm run start
// on tape Ctrl-A + D pour quitter le terminale</p>
<p>Et voila l'application tourne de façon permanente sur ovh1.</p>
<h2>Bilan premier sprint :</h2>
<p>J'ai réalisé le travail que j'avais prévu de faire car j'ai eu la chance de ne rencontrer aucun problème.
J'ai cependant été un peu léger sur la correction de bugs du site mais ça n'était pas la priorité et j'ai amplement le temps durant le second sprint.</p>
<h3>Pour le second sprint :</h3>
<p>Je compte mettre de vrais articles sur le artblog pour que le site soit intéressant à visiter. De plus, je vais tenter de mettre en place une automatisation CI/CD qui permet de pull la dernière version stable sur ovh1 puis de build automatiquement.</p>
<h1>Second Sprint :</h1>
<p>On va se faciliter la vie en écrivant un script qui va mettre à jour, sur ovh1, le site, en allant chercher la dernière version de artblog et en l'activant, ensuite on pourra lancer ce script depuis un pc distant via ssh.
Dans cette partie, on utilise git en ligne de commande.</p>
<h2>Git CLI :</h2>
<p>On commence par mettre à jour notre projet :</p>
<p>git add . // on ajoute les changements au commit
git commit // on commit les changements
git push // on les envoies à l'origine
git checkout main // on va sur la branche main
git merge dev  // on y fusionne la banche dev</p>
<h2>Création du script :</h2>
<p>La première version sera toute basique, on y inclut ces quelques commandes pour tester :</p>
<p>#!/bin/sh</p>
<p>cd /home/curcuma/node/artblog</p>
<p>git pull origin main
npm install
npm run build
npm run start</p>
<p>echo &quot;Prod successfully started&quot;</p>
<p>A ce stade, le script va chercher la dernière version du artblog sur github, installe les dépendances du projet, le build et lance le serveur sur mon port.</p>
<p>Ce script a de nombreux problèmes :</p>
<ul>
<li>Il echo &quot;Prod etc..&quot; peu importe de l'état d’exécution.</li>
<li>Il ne sauvegarde pas les erreurs.</li>
<li>Il n'y a aucun test d'effectué.</li>
<li>Il lance le serveur de prod dans un terminal local, on va le détacher avec screen (puis tmux).</li>
<li>On ne peut que lancer tout le script d'un coup, le script n'est pas optimal si il faut juste redémarrer le serveur.</li>
<li>Il n'est pas possible de voir simplement comment ce que fait le script.</li>
</ul>
<h2>Envoie du script :</h2>
<p>On copy ce script sur le serveur avec scp :</p>
<p>scp /chemin/local/publish.sh utilisteur@serveur:/chemin/distant</p>
<p>Cette commande doit être lancée à chaque modifications.</p>
<h2>On essaie maintenant d'executer le script via ssh :</h2>
<p>ssh nom_d_utilisateur@nom_du_serveur &quot;bash /chemin/distant/publish.sh&quot;</p>
<p>On a un echo : prod succelfully started, ça s'annonce bien. Quelques erreurs de script plus tard, j'ai une version qui fait ce que je demande.
On essaie maintenant d'améliorer le système point par point.</p>
<h2>Creation d'un script pour lancer le script :</h2>
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-cyan-500 bg-cyan-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-cyan-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
</svg>
<div class="pl-8 mr-8">
<p>A ce stade, je ne pense pas que ça soit une bonne idée d'essayer de tout lancer sans voir ce qu'il se passe</p>
</div></div>
<p>Pas forcément utile mais un tout petit script permettrais de mettre à jour le script serveur puis de le lancer dans la foulée.
Je ne le fais pas car je préfère voir si il y a des erreurs, mais il ressemblerait tout simplement à cela :</p>
<p>Prepare_prod :</p>
<p>scp <a href="http://publish.sh">publish.sh</a> [...]
ssh [...] /publish.sh</p>
<h2>Détachement du server dans un terminal en daemon :</h2>
<p>on modifie le script :</p>
<p>screen -S artblog -dmS npm run start</p>
<p>Cette commande devrait lancer le serveur dans un processus deamon nommé artblog, qui sera toujours en route quand je rompt la liaison ssh.</p>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-red-500 bg-red-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
<div class="pl-8 mr-8">
<p>Problème :  la commande screen -list ne référence pas le processus, je ne peux plus arrêter mon serveur. C'est embêtant car impossible de lancer une nouvelle version du serveur si le port est déjà utilisé.</p>
</div></div>
<h3>Debug mode :</h3>
<p>On essaie de trouver le problème, pour commencer, le serveur est bien disponible sur node.curcuma.ovh1, ce qui veut dire que le screen à bien fonctionné.</p>
<p>On trouve le processus qui écoute sur mon port 10438 avec :</p>
<p>ps -ef | grep artblog | awk '{print $2}'
// cette commande liste les processus, ne garde que ceux qui s’appellent artblog et print l'id du process. on reçoit 304108</p>
<p>On kill le processus:</p>
<p>kill 34108</p>
<p>Cela à marché.</p>
<p>On l'inclut dans le script : d'abord on kill l'ancien process, ensuite on pourra en recréer un :</p>
<p>ps -ef | grep artblog |head -n -1 | awk '{print $2}' | xargs kill -15</p>
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-cyan-500 bg-cyan-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-cyan-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
</svg>
<div class="pl-8 mr-8">
<p>La commande se complique :</p>
<ul>
<li>ps -ef : d'abord je récupère les processus</li>
<li>grep artblog : je prend ceux qui contiennent le mot artblog</li>
<li>head -n -1 | : je garde tous sauf la dernière ligne, en effet la dernière ligne est la commande grep elle même et renvoie une erreur par la   suite</li>
<li>awk : je ne print que la deuxième colonne qui correspond au PID</li>
<li>kill : je kill tous les process listés par le print awk.</li>
</ul>
</div></div>
<h3>Retour au script :</h3>
<p>Le script devient :</p>
<pre class="language-bash " style="counter-reset: linenumber 0"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>

    <span class="token builtin class-name">cd</span> /home/curcuma/node/artblog

    <span class="token function">git</span> pull origin main
    <span class="token function">npm</span> <span class="token function">install</span>
    <span class="token function">npm</span> run build

    <span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> artblog <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $2}'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">kill</span> <span class="token parameter variable">-15</span>
    <span class="token function">screen</span> <span class="token parameter variable">-S</span> artblog <span class="token parameter variable">-dmS</span> <span class="token function">npm</span> run start

    <span class="token builtin class-name">echo</span> <span class="token string">"Script ended"</span>
</code></pre>
<p>On l’envoie et on test.</p>
<h2>Séparer le build du projet du lancement du serveur :</h2>
<p>On crée des options qui permettent ou non de build le serveur.</p>
<p>On crée l'option -h qui affiche de l'aide et -b qui lance le build. Par défaut, on lance un screen.</p>
<pre class="language-bash " style="counter-reset: linenumber 0"><code class="language-bash">
<span class="token comment">#!/bin/sh</span>

<span class="token keyword">function</span> <span class="token function-name function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"Pulling from origin..."</span>
  <span class="token function">git</span> pull origin main
  <span class="token builtin class-name">echo</span> <span class="token string">"Installing dependancies..."</span>
  <span class="token function">npm</span> <span class="token function">install</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"Building ..."</span>
  <span class="token function">npm</span> run build
  
<span class="token punctuation">}</span>


<span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> <span class="token string">":hb"</span> opt<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">case</span> <span class="token variable">$opt</span> <span class="token keyword">in</span>
    h<span class="token punctuation">)</span>
      <span class="token builtin class-name">echo</span> <span class="token string">"This is the help section of the script test.sh"</span>
      <span class="token builtin class-name">echo</span> <span class="token string">"Available options are:"</span>
      <span class="token builtin class-name">echo</span> <span class="token string">"-h : display this help section"</span>
      <span class="token builtin class-name">echo</span> <span class="token string">"-b : run the Build function"</span>
      <span class="token builtin class-name">exit</span> <span class="token number">0</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    b<span class="token punctuation">)</span>
      Build
      <span class="token builtin class-name">exit</span> <span class="token number">0</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token punctuation">\</span>?<span class="token punctuation">)</span>
      <span class="token builtin class-name">echo</span> <span class="token string">"Invalid option: -<span class="token variable">$OPTARG</span>"</span> <span class="token operator">></span><span class="token file-descriptor important">&amp;2</span>
      <span class="token builtin class-name">exit</span> <span class="token number">1</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token keyword">esac</span>
<span class="token keyword">done</span>

<span class="token builtin class-name">cd</span> /home/curcuma/node/artblog

<span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> artblog <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n</span> <span class="token parameter variable">-1</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $2}'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">kill</span> <span class="token parameter variable">-15</span>
<span class="token function">screen</span> <span class="token parameter variable">-S</span> artblog <span class="token parameter variable">-dmS</span> <span class="token function">npm</span> run start

<span class="token builtin class-name">echo</span> <span class="token string">"Script ended"</span>

</code></pre>
<p>Mais à cause de je ne sais quoi le screen ne marche pas a travers ssh.
On essaie la même chose en utilisant tmux au lieu de screen.</p>
<p>On remplace les lignes liées a screen part</p>
<pre class="language-bash " style="counter-reset: linenumber 0"><code class="language-bash">tmux kill-session <span class="token parameter variable">-t</span> artblogDeamon
tmux new-session <span class="token parameter variable">-d</span> <span class="token parameter variable">-s</span> artblogDeamon <span class="token string">"npm run start"</span>

</code></pre>
<p>Et cela fonctionne !</p>
<p>On peut maintenant lancer <a href="http://publish.sh">publish.sh</a> en ssh pour</p>
<ul>
<li>afficher l'aide grâce à -h</li>
<li>pull la version la plus récente sur git et build le projet grâce à -b</li>
<li>et publier le serveur.</li>
</ul>
<p>Tout cela avec par exemple <code>ssh curcuma@ovh1.ec-m.fr &quot;bash ./node/artblog/publish.sh -h&quot;</code></p>
<h2>Récupértions des erreurs :</h2>
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-pink-500 bg-pink-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-pink-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
</svg>
<div class="pl-8 mr-8">
<p>On part sur du Bash un peu plus poussé que juste des echo et des commandes git.</p>
</div></div>
<p>Pour être un peu sérieux, on ajoute au script une fonction qui récupère les erreurs à chaque commande lancée. Ces erreurs seront casées dans un fichier de log. On formate les erreurs pour qu'elles affichent la date, la commande lancée avec ses options, et ensuite on print l'erreur.</p>
<p>Pour cela, on utilise des spécificités bien pratique de bash comme les stderr, le pipe, les $?, les variables d’environnements etc...</p>
<pre class="language-bash " style="counter-reset: linenumber 0"><code class="language-bash"><span class="token function-name function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token assign-left variable">command</span><span class="token operator">=</span><span class="token variable">$1</span>   <span class="token comment"># 1)</span>
   <span class="token assign-left variable">log_file</span><span class="token operator">=</span><span class="token environment constant">$PWD</span>/error.log <span class="token comment"># 2)</span>
   <span class="token assign-left variable">stderr</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$command <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">></span>/dev/null<span class="token variable">)</span></span> <span class="token comment"># 3)</span>
   <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-ne</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token comment"># 4)</span>
       <span class="token builtin class-name">echo</span> <span class="token string">"Error: <span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F_%R<span class="token variable">)</span></span> <span class="token variable">$command</span> "</span> <span class="token operator">>></span> <span class="token variable">$log_file</span>
       <span class="token builtin class-name">echo</span> <span class="token string">"      <span class="token variable">$stderr</span>"</span> <span class="token operator">>></span> <span class="token variable">$log_file</span>
       <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$stderr</span>"</span> <span class="token comment"># 5)</span>
   <span class="token keyword">fi</span>
 <span class="token punctuation">}</span>
</code></pre>
<p>La fonction est compliquée et on y arrive après plusieurs itérations.</p>
<p>Explication détaillée :</p>
<ul>
<li>
<ol>
<li>On prend une commande en paramètre</li>
</ol>
</li>
<li>
<ol start="2">
<li>on choisi le fichier error.log dans lequel on va placer nos log d'erreurs</li>
</ol>
</li>
<li>
<ol start="3">
<li>on créer une variable stderr qui contient l'erreur standard de la commande. Pour cela, on lance la commande et on redirige l'erreur dans le stdout et on envoi ce stdout dans /dev/null pour qu'il ne soit pas affiché dans le terminal</li>
</ol>
</li>
<li>
<ol start="4">
<li>Si la commande à terminé avec un exit code != 0, on sait qu'il y a une erreur, on va donc former un message d'erreur à mettre dans le fichier log</li>
</ol>
</li>
<li>
<ol start="5">
<li>Ce message d'erreur contient 2 lignes, une avec la date formatée et la commande, l'autre avec la stderr récupérée plutôt. Enfin, on echo dans le terminal utilisé la stderr pour avoir l'erreur sans aller fouillé le fichier de logs</li>
</ol>
</li>
</ul>
<p>On peut maintenant 'wrapper' toutes nos fonctions avec cette Error_Handler pour que toutes les commandes me donnent des logs en cas d'erreur.</p>
<h3>Problème de wrap :</h3>
<p>La commande du tmux agit mal quand elle est placée dans Error_Handler. Je suspecte que ça à un lien avec le fait qu'il y ait 3 fonctions imbriqués.
Je recopie juste la fonction Error_handler directement autour du tmux. Cela à l'avantage de marcher, mais l'inconvénient de baisser la qualitée de mon code. En effet il y a de la recopie et si je veux modifier le nom du fichier de logs par exemple, je dois le faire 2 fois maintenant.</p>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-red-500 bg-red-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
<div class="pl-8 mr-8">
<p>Avec ce genre de fonction, et surtout en bash, il faut faire attention.
$command désigne la variable alors que $($command) l’exécute. La syntax est crucial, surtout dans ce genre de script ou il est crucial de ne lancer la commande qu'une fois, et non pas plusieurs.
Ici, le script lance la commande une unique fois, c'est ce qu'on veut.</p>
</div></div>
<p>De plus, on conditionne le tmux-kill pour qu'il ne se lance que si il n'y a pas de session artblog déjà présente. Cela permet de ne lancer la commande que si nécessaire puis ça permet d'éviter d'ajouter des logs inutiles dans error.log à chaque fois que la fonction est exécutée.</p>
<p>le script devient :</p>
<pre class="language-bash " style="counter-reset: linenumber 0"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>

<span class="token keyword">function</span> <span class="token function-name function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token assign-left variable">command</span><span class="token operator">=</span><span class="token variable">$1</span>
   <span class="token assign-left variable">log_file</span><span class="token operator">=</span><span class="token environment constant">$PWD</span>/error.log
   <span class="token assign-left variable">stderr</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$command <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">></span>/dev/null<span class="token variable">)</span></span>
   <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-ne</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
       <span class="token builtin class-name">echo</span> <span class="token string">"Error: <span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F_%R<span class="token variable">)</span></span> <span class="token variable">$command</span>"</span> <span class="token operator">>></span> <span class="token variable">$log_file</span>
       <span class="token builtin class-name">echo</span> <span class="token string">"    <span class="token variable">$stderr</span>"</span> <span class="token operator">>></span> <span class="token variable">$log_file</span>
       <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$stderr</span>"</span>
   <span class="token keyword">fi</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function-name function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token builtin class-name">echo</span> <span class="token string">"Pulling from origin..."</span>
 Error_Handler <span class="token string">"git pull origin main"</span>
 <span class="token builtin class-name">echo</span> <span class="token string">"Installing dependancies..."</span>
 Error_Handler <span class="token string">"npm install"</span>
 <span class="token builtin class-name">echo</span> <span class="token string">"Building ..."</span>
 Error_Handler <span class="token string">"npm run build"</span>
 
<span class="token punctuation">}</span>


<span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> <span class="token string">":hb"</span> opt<span class="token punctuation">;</span> <span class="token keyword">do</span>
 <span class="token keyword">case</span> <span class="token variable">$opt</span> <span class="token keyword">in</span>
   h<span class="token punctuation">)</span>
     <span class="token builtin class-name">echo</span> <span class="token string">"This is the help section of the script test.sh"</span>
     <span class="token builtin class-name">echo</span> <span class="token string">"Available options are:"</span>
     <span class="token builtin class-name">echo</span> <span class="token string">"-h : display this help section"</span>
     <span class="token builtin class-name">echo</span> <span class="token string">"-b : pull the main branch of the project, build the project and publish it on internet"</span>
     <span class="token builtin class-name">echo</span> <span class="token string">"no options will only publish the project"</span>
     <span class="token builtin class-name">exit</span> <span class="token number">0</span>
     <span class="token punctuation">;</span><span class="token punctuation">;</span>
   b<span class="token punctuation">)</span>
     Build
     <span class="token punctuation">;</span><span class="token punctuation">;</span>
   <span class="token punctuation">\</span>?<span class="token punctuation">)</span>
     <span class="token builtin class-name">echo</span> <span class="token string">"Invalid option: -<span class="token variable">$OPTARG</span>"</span> <span class="token operator">></span><span class="token file-descriptor important">&amp;2</span>
     <span class="token builtin class-name">exit</span> <span class="token number">1</span>
     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token keyword">esac</span>
<span class="token keyword">done</span>

<span class="token builtin class-name">cd</span> /home/curcuma/node/artblog


<span class="token assign-left variable">session_status</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>tmux list-sessions <span class="token operator">|</span> <span class="token function">grep</span> artblogDeamon<span class="token variable">)</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$session_status</span> <span class="token operator">=~</span> <span class="token string">"artblogDeamon"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
 Error_Handler <span class="token string">"tmux kill-session -t artblogDeamon"</span>
<span class="token keyword">fi</span>

<span class="token assign-left variable">stderrTmux</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>tmux new-session <span class="token parameter variable">-d</span> <span class="token parameter variable">-s</span> artblogDeamon <span class="token string">"npm run start"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">></span>/dev/null<span class="token variable">)</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-ne</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
       <span class="token builtin class-name">echo</span> <span class="token string">"Error: <span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F_%R<span class="token variable">)</span></span> tmux new-session -d -s artblogDeamon <span class="token entity" title="\&quot;">\"</span>npm run start<span class="token entity" title="\&quot;">\"</span> "</span> <span class="token operator">>></span> <span class="token environment constant">$PWD</span>/error.log
       <span class="token builtin class-name">echo</span> <span class="token string">"    <span class="token variable">$stderrTmux</span>"</span> <span class="token operator">>></span> <span class="token environment constant">$PWD</span>/error.log
       <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$stderrTmux</span>"</span>
   <span class="token keyword">fi</span>



<span class="token builtin class-name">echo</span> <span class="token string">"Script succesfuly ended"</span>
<span class="token builtin class-name">exit</span> <span class="token number">0</span>

</code></pre>
<p>Le script fonctionne come voulue, voici un exemple de logs que l'on récupère si il y a des erreurs :</p>
 <img src="../images/error1.png" alt="error log" style="height: 200px; margin: 0 auto; border: 0">
<div class="quote relative  py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-cyan-500 bg-cyan-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-cyan-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
</svg>
<div class="pl-8 mr-8">
<p>Pour aller plus loin, on peut automatiser le lancement de se script, suivant certaines conditions, avec Jenkins par exemple, comme dans <a href="../../../../mon/TBi/MON/Jenkins">ce MON</a></p>
</div></div>
<h2>Bilan second sprint :</h2>
<p>Je suis partie dans une direction différente que prévu. Dans une démarche DevOps, la mise en production est un 'non événement', c'est à dire qu'il doit se faire facilement, rapidement, et aussi souvent que nécessaire. Grâce à ce petit script, on se rapproche de cette démarche.
Je n'ai cependant pas eu le temps de remplir mon site de vrai articles.</p>


</article>

        </main>


        <footer class="min-h-[50px] border-t-2 border-gray-200 mt-4">
            <div class="max-w-[1000px] mx-auto px-4">
                <div class="min-h-[50px] flex justify-center items-center">
                    <p class="text-center">
                        <span style="font-family: Consolas, sans-serif;">Do_<span style="color: #4a86e8">It</span></span> : Développent et Organisation en IT
                    </p>
                </div>
            </div>
        </footer>

        <script>
        MathJax
            .startup
            .document
            .getMathItemsWithin(document.body);
        </script>

    </body>
</html>
