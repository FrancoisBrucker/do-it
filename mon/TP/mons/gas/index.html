<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>MON 2 : Google Apps Script</title>

    <link href="/do-it/assets/node_modules/prismjs/themes/prism-solarizedlight.min.css" rel="stylesheet">
    <link href="/do-it/assets/node_modules/prismjs/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">

    <link href="/do-it/assets/stylesheets/main.css" rel="stylesheet">
  </head>
  <body>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            [
              '$', '$'
            ],
            [
              '\\(', '\\)'
            ]
          ]
        },
        svg: {
          fontCache: 'global'
        }
      };
    </script>
    

    <header class="border-b-2 border-gray-200 mb-4">
      <div class="max-w-[1000px] mx-auto px-4">
        <div class="min-h-[50px] flex justify-between items-center">
          <a class="mx-2" href="/do-it/">Home</a>
          <a class="mx-2" href="/do-it/about">About</a>
        </div>
      </div>
    </header>

    <main class="max-w-[1000px] mx-auto px-4">

      
<article>
  <h1 class="mb-1">MON 2 : Google Apps Script</h1>
  <div class="mb-4">
    
      <div class=" px-4 flex items-center">
        
          <div class="font-bold">Tag : </div>
        
        <ul class="flex not-prose list-none my-0 last:after:content-['•'] last:after:px-1 mx-0 px-1">
          
            <li class="before:content-['•'] before:px-1">Google Apps Script</li>
          
        </ul>
      </div>
    

    
      <div class=" px-4 flex items-center">
        
          <div class="font-bold">Auteur : </div>
        
        <ul class="flex not-prose list-none my-0 last:after:content-['•'] last:after:px-1 mx-0 px-1">
          
            <li class="before:content-['•'] before:px-1">Thomas Pont</li>
          
        </ul>
      </div>
    
  </div>

  

  <!-- Début Résumé -->
<p>Google Apps Script</p>
<!-- Début Résumé -->
<h2>Objectif de ce MON</h2>
<p>L'objectif de ce MON est d'automatiser une tâche avec Google App Script.</p>
<p>Ici on cherchera à automatiser l'envoi de mails personnalisés. à des personnes.</p>
<p>Pour cela, on va réaliser un programme qui va automatiser l'envoi de mail lors de l'organisation d'évènements (réunions, cours..). A la fin, il faudrait que l'on ait juste à indiquer dans un Google Sheet, le prénom, le nom, le mail du participant ainsi que la nature, la date et l'heure de l'évènement auquel il est convié et qu'un mail comme celui qui suit s'envoie automatiquement.</p>
<pre class="language-txt " style="counter-reset: linenumber 0"><code class="language-txt">Bonjour Jean Dupont,

Vous êtes conviés à la réunion de fin de projet le 24/10/2022 à 15h.

Cordialement,
Yves Martin
</code></pre>
<h2>Réalisation de ce programme</h2>
<p>Dans un premier temps, j'ai relu et étudié les précédents MON fait sur Google App Script pour revoir les principales fonctionnalités déjà utilisé et principalement celle de l'envoi de mail.</p>
<h3>Fichier texte</h3>
<p>Pour commencer on crée un Google Doc avec le texte que l'on souhaite envoyer aux différents destinataires du mail.</p>
<pre class="language-txt " style="counter-reset: linenumber 0"><code class="language-txt"> Bonjour [Prenom] [Nom],

 Vous êtes conviés [Evenement] le [Date] à [Heure].

 Cordialement,
 Yves Martin
</code></pre>
<p>Les éléments entre crochets seront ensuite automatiquement remplacé en fonction des informations sur la personne et sur l'évènement.</p>
<p>On doit ensuite convertir ce texte en HTML pour qu'il puisse être bien envoyé. Pour cela, on récupère une fonction publique disponible sur ce <a href="https://github.com/oazabir/GoogleDoc2Html/blob/master/code.js">Github</a>.<br>
On nomme le texte ainsi converti mailBodyHTML</p>
<h3>Google Sheet</h3>
<p>On crée un Google Sheet permettant de réunir les éléments des mails que l'on doit envoyer. On le place dans un onglet intitulé Inscriptions.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Nom</th>
<th style="text-align:left">Prénom</th>
<th style="text-align:left">Mail</th>
<th style="text-align:left">Date</th>
<th style="text-align:left">Heure</th>
<th style="text-align:left">Nom Evènement</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Dupont</td>
<td style="text-align:left">Jean</td>
<td style="text-align:left"><a href="mailto:jean.dupont@gmail.com">jean.dupont@gmail.com</a></td>
<td style="text-align:left">24/10/2022</td>
<td style="text-align:left">15h</td>
<td style="text-align:left">à la réunion de fin de projet</td>
</tr>
<tr>
<td style="text-align:left">Dulieu</td>
<td style="text-align:left">Anna</td>
<td style="text-align:left"><a href="mailto:anna.dulieu@gmail.com">anna.dulieu@gmail.com</a></td>
<td style="text-align:left">24/10/2022</td>
<td style="text-align:left">15h</td>
<td style="text-align:left">à la réunion de fin de projet</td>
</tr>
</tbody>
</table>
<h3>Personnalisation du mail</h3>
<p>Il faut ensuite qu'on écrive un script qui prend les informations du tableau et qui complète automatiquement le texte du mail.</p>
<p>Dans une fonction, on extrait les données du tableau de cette manière :</p>
<pre class="language-java " style="counter-reset: linenumber 0"><code class="language-java"><span class="token keyword">const</span> nom <span class="token operator">=</span> inscriptions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> prenom <span class="token operator">=</span> inscriptions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> email <span class="token operator">=</span> inscriptions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>inscriptions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dateFormatee <span class="token operator">=</span> <span class="token class-name">Utilities</span><span class="token punctuation">.</span><span class="token function">formatDate</span><span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token string">"GMT+1"</span><span class="token punctuation">,</span> <span class="token string">"dd/MM/YYYY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> heure <span class="token operator">=</span> inscriptions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sujet <span class="token operator">=</span> inscriptions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<div class="quote relative py-2 drop-shadow rounded rounded-tl-none rounded-bl-none border-solid border-l-8 border-red-500 bg-red-100">
<svg class="absolute w-7 h-7 pl-1 pt-0.5 pb-0.5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
<div class="pl-8  mb-2 mr-8">
<p><strong>Attention</strong> aux dates</p>
</div><div class="pl-8 mr-8">
<p>Il faut faire attention à la gestion des dates dans le tableau. Si on fait seulement</p>
<pre class="language-java " style="counter-reset: linenumber 0"><code class="language-java"><span class="token keyword">const</span> date <span class="token operator">=</span> inscriptions <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p>rien ne sera extrait du tableau<br>
De même si on formate pas la date on récupère également l'heure de minuit ainsi que le fuseau horaire de là où on se situe.<br>
Il est donc important de bien l'extraire et de bien la formater.</p>
</div></div>
<p>On place toutes ses données ainsi récupérées dans un tableau <em>variables</em>.<br>
Pour compléter le texte on utilise la fonction suivante :</p>
<pre class="language-java " style="counter-reset: linenumber 0"><code class="language-java">  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> id in variables<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>variables<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mailBodyHTML <span class="token operator">=</span> mailBodyHTML<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"["</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">"]"</span><span class="token punctuation">,</span>variables<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>Ceci permet de lire le texte du mail et de remplacer les [] par l'information correspondante.</p>
<h3>Envoi du mail</h3>
<p>Il faut maintenant lier les scripts pour le texte ainsi former puisse être envoyé et qu'il le soit à la bonne personne.</p>
<p>Pour cela, on peut utiliser la commande ci-dessous :</p>
<pre class="language-java " style="counter-reset: linenumber 0"><code class="language-java"><span class="token class-name">MailApp</span><span class="token punctuation">.</span><span class="token function">sendEmail</span><span class="token punctuation">(</span>mailTo<span class="token punctuation">,</span> mailSubject<span class="token punctuation">,</span> mailBodyHTML<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token operator">^</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">/</span>g<span class="token punctuation">,</span> ''<span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>On peut choisir l'intitulé tel que Convocation qu'on peut stocker dans une constante.</p>
<p>On peut retrouver ici le tableau avec le Google App Script final. L'envoi du mail se fait lorsqu'on l'on lance la fonction gestionConvocations.</p>
<p>Ainsi on peut lancer manuellement cette fonction et le bon mail s'enverra à Jean et Anna. Il reste cependant un problème. Si on décide d'envoyer ce mail à quelqu'un d'autre, qu'on rajoute cette personne dans le tableau, le mail se renverra également à Jean et Anna.<br>
Pour pallier à ce problème on peut ajouter une colonne intitulée <em>Mail envoyé</em>. On place des cases non cochées dans ce tableau. Lorsque le mail est bien envoyé un ajoute une ligne dans le code pour que la case soit cochée.</p>
<pre class="language-java " style="counter-reset: linenumber 0"><code class="language-java">inscriptionsSheet<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"TRUE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Si on relance le script, en vérifiant si la case est bien décochée, seules les lignes non cochées vont recevoir le mail.</p>
<h2>Lien vers le code</h2>
<p><a href="./code/code_gas">Mon code</a></p>


</article>

    </main>

    <footer class="min-h-[50px] border-t-2 border-gray-200 mt-4">
      <div class="max-w-[1000px] mx-auto px-4">
        <div class="min-h-[50px] flex justify-center items-center">
          <p>
            do-it : option de troisième année à l'école centrale Marseille
          </p>
        </div>
      </div>
    </footer>

    <script>
      MathJax
        .startup
        .document
        .getMathItemsWithin(document.body);
    </script>

  </body>
</html>
