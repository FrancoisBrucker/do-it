
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <title>POK 3</title>

    <link href=/do-it/assets/node_modules/prismjs/themes/prism-solarizedlight.min.css rel="stylesheet">
    <link href=/do-it/assets/node_modules/prismjs/plugins/line-numbers/prism-line-numbers.min.css rel="stylesheet">

    <link href=/do-it/assets/stylesheets/main.css rel="stylesheet">
  </head>
  <body>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            [
              '$', '$'
            ],
            [
              '\\(', '\\)'
            ]
          ]
        },
        svg: {
          fontCache: 'global'
        }
      };
    </script>
    <script type="text/javascript" id="MathJax-script" 
  src=/do-it/assets/node_modules/mathjax/es5/tex-svg-full.js></script>

    <header class="border-b-2 border-gray-200 mb-4">
      <div class="max-w-[1000px] mx-auto px-4">
        <div class="min-h-[50px] flex justify-between items-center">
          <a class="mx-2" href="/do-it/">Home</a>
          <a class="mx-2" href="/do-it/about">About</a>
        </div>
      </div>
    </header>

    <main class="max-w-[1000px] mx-auto px-4">

      
<article>
  <h1  class="mb-1">POK 3</h1>
  <div class="mb-4">
    
      <div class=" px-4 flex items-center">
        
          <div class="font-bold">Tags : </div>
        
        <ul class="flex not-prose list-none my-0 last:after:content-['•'] last:after:px-1 mx-0 px-1">
          
            <li class="before:content-['•'] before:px-1">docker</li>
          
            <li class="before:content-['•'] before:px-1">login</li>
          
            <li class="before:content-['•'] before:px-1">angular</li>
          
            <li class="before:content-['•'] before:px-1">express</li>
          
            <li class="before:content-['•'] before:px-1">test</li>
          
            <li class="before:content-['•'] before:px-1">javascript</li>
          
        </ul>
      </div>
    

    
      <div class=" px-4 flex items-center">
        
          <div class="font-bold">Auteur : </div>
        
        <ul class="flex not-prose list-none my-0 last:after:content-['•'] last:after:px-1 mx-0 px-1">
          
            <li class="before:content-['•'] before:px-1">Antoine Varnerot</li>
          
        </ul>
      </div>
    
  </div>

  

  <head>
  <link rel="stylesheet" href="../../assets/style.css">
</head>
<h2>Plan du POK</h2>
<h2>Sprint 1</h2>
<ul>
<li><s>sign in (back)</s></li>
<li><s>sign up (back)</s></li>
<li><s>sign out (back)</s></li>
<li><span style="color:orange">login (front)</span></li>
<li><span style="color:orange">noter les musiques</span></li>
<li><s>déployer en ligne</s></li>
</ul>
<h2>Sprint 2</h2>
<ul>
<li><s>tests unitaires</s></li>
<li><s>utilisation de docker</s></li>
<li>CI (avec gitlab peut-être ou directement avec les &quot;actions&quot; de GitHub)</li>
</ul>
<h2>Points difficiles/techniques</h2>
<ol>
<li>Mise en ligne de l'API</li>
</ol>
<p>L'API et le front-ent étant décomposés en deux dossier différents, on commence d'abord par mettre en ligne l'API sur l'OVH.<br>
Tout d'abord dans notre API, on replace le port dé déploiement par défaut par un port géré par l'OVH. Dans notre fichier <code>server.js</code> on remplace le port 3000 par le 8080 comme suit:</p>
<pre class="language-js " style="counter-reset: linenumber 0"><code class="language-js"><span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token function">normalizePort</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token string">'8080'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>On voudra lancer la commande <code>nodemon serve</code> sur notre OVH une fois les fichiers déployés, mais l'OVH ne reconnait pas la commande nodemon directement, cependant il reconnait les commandes npm.<br>
Pour pouvoir lancer la commande nodemon, il faut donc la renseigner dans notre fichier <code>package.json</code>:</p>
<pre class="language-json " style="counter-reset: linenumber 0"><code class="language-json">scripts"<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"nodemon serve"</span><span class="token punctuation">,</span>
</code></pre>
<p>Il nous suffit maintenant de copier les fichiers de notre dossier API dans le dossier /node de l'OVH puis, directement depuis la console, lancer notre commande</p>
<pre class="language-shell " style="counter-reset: linenumber 0"><code class="language-shell"><span class="token function">npm</span> run serve
</code></pre>
<p>L'API est désormais en ligne sur le port 8080.</p>
<ol start="2">
<li>Mise en ligne du front</li>
</ol>
<p>Maintenant que notre API est en ligne sur l'OVH, il faut relier le front-end à l'API en changeant l'adresse des requêtes.<br>
Dans <code>/src/app/services/music.service.ts</code>, on va remplacer les URL par ceux de l'API en ligne comme suit:</p>
<pre class="language-js " style="counter-reset: linenumber 0"><code class="language-js"><span class="token function">getMusics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://node.origan.ovh1.ec-m.fr:8080/api/musics</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span>get<span class="token operator">&lt;</span>Music<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">addMusic</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">newMusic</span><span class="token operator">:</span> Partial<span class="token operator">&lt;</span>Music<span class="token operator">></span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://node.origan.ovh1.ec-m.fr:8080/api/newMusic</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span>post<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> newMusic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>On build notre application localement avec la commande <code>npm run build</code>. Cela va nous générer les fichiers nécessaire à déployer.<br>
Un dossier <code>/dist</code> s'est alors créé avec un sous-dossier (chez nous: <code>/projet3a</code>)</p>
<p>On supprime au prélable sur l'OVH tous les fichiers du dossier <code>/www</code>, puis on colle tout le contenu de notre dossier dans ce dernier.</p>
<p>Notre site est désormais en ligne, et en se connectant on remarque que le front-end fonctionne correctement et communique bien avec l'API puisque les infos du feed de musique ont bien été collectées depuis MongoDB</p>
<ol start="3">
<li>Authentification</li>
</ol>
<p>Pour le système d'authentification, on avait sous-estimé le temps que ca prendrait. En effet, on a utilisé les JWT tokens et même si on a trouvé un tutoriel sur le site <a href="https://www.bezkoder.com/">https://www.bezkoder.com/</a>, il y avait eu quelques changements depuis que ce tutoriel a été fait et notre application express était en &quot;type: module&quot; (paramètre dans le package.json) et ca gênait beaucoup. On a préféré terminé cela parce que c'était un gros point technique du projet et qui allait nous servir pour d'autres projets.</p>
<ol start="5">
<li>Utilisation de Docker (docker-compose)</li>
</ol>
<p>Il est dans notre cas possible d'utiliser l'outil Docker Compose pour créer une application multi-conteneurs avec le front et l'API.</p>
<p>Tout d'abord il nous faut définir le Dockerfile pour l'API.<br>
Dans notre dossier <code>/front</code> on crée un fichier <code>Dockerfile</code> puis on copie le code suivant:</p>
<pre class="language-dockerfile " style="counter-reset: linenumber 0"><code class="language-dockerfile"><span class="token instruction"><span class="token keyword">FROM</span> node:14-alpine <span class="token keyword">as</span> development</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /usr/src/app/front</span>

<span class="token instruction"><span class="token keyword">COPY</span> package*.json ./</span>

<span class="token instruction"><span class="token keyword">RUN</span> npm install -g @angular/cli @angular-devkit/build-angular &amp;&amp; npm install</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> 4201</span>

<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"npm"</span>, <span class="token string">"start"</span>]</span>
</code></pre>
<p>Dans notre fichier <code>package.json</code> on cherche la ligne associée à la commande &quot;start&quot; et on remplace par</p>
<pre class="language-json " style="counter-reset: linenumber 0"><code class="language-json"><span class="token string">"ng serve --host=0.0.0.0 --port 4201"</span><span class="token punctuation">,</span>
</code></pre>
<p>Pareil dans le dossier API on crée un fichier <code>Dockerfile</code> qui contient le code:</p>
<pre class="language-dockerfile " style="counter-reset: linenumber 0"><code class="language-dockerfile"><span class="token instruction"><span class="token keyword">FROM</span> node:14-alpine <span class="token keyword">as</span> development</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /usr/src/app/api</span>

<span class="token instruction"><span class="token keyword">COPY</span> package*.json ./</span>

<span class="token instruction"><span class="token keyword">RUN</span> npm install</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> 3080</span>

<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"npm"</span>, <span class="token string">"run"</span>, <span class="token string">"start"</span>]</span>
</code></pre>
<p>Dans notre fichier <code>package.json</code> on cherche la ligne associée à la commande &quot;start&quot; et on remplace par</p>
<pre class="language-json " style="counter-reset: linenumber 0"><code class="language-json"><span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"nodemon serve"</span><span class="token punctuation">,</span>
</code></pre>
<p>On supprime les dossiers <code>node_modules</code> et le fichier <code>package-lock.json</code> pour éviter les potentiels conflits et erreurs.</p>
<p>On crée notre fichier <code>docker-compose.yml</code></p>
<pre class="language-yml " style="counter-reset: linenumber 0"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodejs-server</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span>
      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./API
      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"3080:3080"</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>api
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./API<span class="token punctuation">:</span>/usr/src/app/api
      <span class="token punctuation">-</span> /usr/src/app/api/node_modules
  <span class="token key atrule">angular-ui</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span>
      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./front
      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"4201:4201"</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> angular<span class="token punctuation">-</span>ui
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./front<span class="token punctuation">:</span>/usr/src/app/front
      <span class="token punctuation">-</span> /usr/src/app/app<span class="token punctuation">-</span>ui/node_modules
</code></pre>
<p>Et il suffit dans le terminal les commandes suivantes pour lancer en local l'application</p>
<pre class="language-bash " style="counter-reset: linenumber 0"><code class="language-bash"><span class="token function">docker-compose</span> build --no-cache
<span class="token function">docker-compose</span> up
</code></pre>
<p>Attention à bien changer les ports et les appels à l'API dans le code de l'application !</p>


</article>

    </main>

    <footer class="min-h-[50px] border-t-2 border-gray-200 mt-4">
      <div class="max-w-[1000px] mx-auto px-4">
        <div class="min-h-[50px] flex justify-center items-center">
          <p>
            do-it : option de troisième année à l'école centrale Marseille
          </p>
        </div>
      </div>
    </footer>

    <script>
      MathJax
        .startup
        .document
        .getMathItemsWithin(document.body);
    </script>

  </body>
</html>
